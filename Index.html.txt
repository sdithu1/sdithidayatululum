<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Absensi GURU</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    /* =========================================
       1. GLOBAL SETTINGS & FONTS
       ========================================= */
    /* Menggunakan font 'Plus Jakarta Sans' untuk kesan modern startup & enterprise */
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --secondary: #64748b;
      --bg-body: #f8fafc;
      --glass-border: rgba(255, 255, 255, 0.5);
    }

    body { 
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg-body);
      color: #1e293b; /* Slate-800 */
      overflow-x: hidden; 
      margin: 0; padding: 0;
      -webkit-font-smoothing: antialiased;
    }

    /* Utility untuk menyembunyikan elemen */
    .hidden-section { display: none !important; }

    /* =========================================
       2. CUSTOM SCROLLBAR
       ========================================= */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Scrollbar sidebar (lebih tipis/gelap) */
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

    /* =========================================
       3. LOGIN PAGE (PREMIUM GLASSMORPHISM)
       ========================================= */
    .login-container {
        position: relative;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow: hidden;
    }

    .login-bg-image {
        position: absolute;
        inset: 0;
        
        /* --- PILIH SALAH SATU GAMBAR DI BAWAH INI --- */

        /* OPSI 1: Suasana Guru Rapat/Diskusi (Tampil Profesional & Serius) - DEFAULT */
        background-image: url('https://images.unsplash.com/photo-1577896851231-70ef18881754?q=80&w=2070&auto=format&fit=crop'); 


        background-size: cover;
        background-position: center;
        z-index: 0;
        
        /* Efek Zoom perlahan agar terlihat hidup */
        animation: slowZoom 20s infinite alternate;
    }

    /* Overlay Gradient Gelap */
    .login-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.8) 100%);
        backdrop-filter: blur(8px);
        z-index: 1;
    }

    /* Kartu Login Kaca */
    .modern-login-card {
        position: relative;
        z-index: 10;
        width: 100%;
        max-width: 420px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 28px;
        padding: 40px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    .logo-wrapper {
        width: 80px; height: 80px; margin: 0 auto 16px;
        background: white; border-radius: 20px; padding: 10px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex; align-items: center; justify-content: center;
    }
    .logo-img-login { width: 100%; height: 100%; object-fit: contain; }

    /* =========================================
       4. SIDEBAR & NAVIGATION (Enterprise Dark)
       ========================================= */
    .sidebar-gradient {
        background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); /* Slate-900 */
    }
    
    .nav-item {
        position: relative; overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px; margin-bottom: 4px;
        color: #94a3b8; /* Slate-400 */
    }
    
    /* Menu Aktif */
    .nav-item.active-menu { 
        background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .nav-item:hover:not(.active-menu) {
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
    }

    /* =========================================
       5. DASHBOARD WIDGETS
       ========================================= */
    /* Glass Card untuk Konten Dashboard */
    .glass-card {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px 0 rgba(0,0,0,0.05);
        border-radius: 16px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .glass-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 20px -8px rgba(0, 0, 0, 0.15);
    }

    .stat-card-icon {
        display: flex; align-items: center; justify-content: center;
        width: 48px; height: 48px; border-radius: 12px;
    }

    /* Table Styles */
    table thead th {
        letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.75rem;
    }
    table tbody tr { transition: background-color 0.1s; }
    table tbody tr:hover { background-color: #f8fafc; }

    /* =========================================
       6. ANIMASI (KEYFRAMES)
       ========================================= */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

    @keyframes scale-up {
        0% { opacity: 0; transform: scale(0.95); }
        100% { opacity: 1; transform: scale(1); }
    }
    .animate-scale-up { animation: scale-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

    @keyframes slowZoom {
        from { transform: scale(1); }
        to { transform: scale(1.1); }
    }

    @keyframes pulse-soft {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.05); }
    }
    .animate-pulse-soft { animation: pulse-soft 2s infinite; }

    /* =========================================
       7. OTHER UTILITIES
       ========================================= */
    /* Map & Modal Fixes */
    .leaflet-pane { z-index: 1 !important; }
    .leaflet-top, .leaflet-bottom { z-index: 2 !important; }

    /* Filter Button */
    .filter-btn-hari.active {
        background-color: #2563eb; color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }

    /* Mobile Responsive Adjustments */
    @media (max-width: 640px) {
        .modern-login-card { padding: 30px 24px; border-radius: 24px; }
        .login-header-title { font-size: 1.5rem; }
    }
</style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased selection:bg-blue-500 selection:text-white">

  <div id="initialLoader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-600 mb-4"></div>
    <p class="text-slate-500 font-medium animate-pulse tracking-wide text-sm">Memuat Sistem...</p>
  </div>

  <div id="toast" class="fixed top-6 right-6 z-[110] hidden transform transition-all duration-300 translate-y-[-20px] opacity-0">
    <div class="bg-white shadow-xl rounded-xl px-5 py-4 border-l-4 border-blue-500 flex items-center transition-all duration-300 ring-1 ring-black/5">
      <i class="fas fa-info-circle text-blue-500 mr-3 text-xl"></i>
      <span id="toastMsg" class="font-medium text-sm text-slate-700">Pesan Notifikasi</span>
    </div>
  </div>

<section id="loginSection" class="login-container hidden-section">
  
  <div class="login-bg-image"></div>
  <div class="login-overlay"></div>

  <div class="modern-login-card animate-scale-up">
    
    <div class="text-center mb-8">
      <div class="logo-wrapper">
        <img src="<?= settings.App_Logo || 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg/250px-Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg.png' ?>" 
             alt="Logo Instansi" class="logo-img-login">
      </div>

      <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight mb-1">
        <?= settings.App_Name || 'Sistem Informasi Sekolah' ?>
      </h1>
      <p class="text-sm text-slate-500 font-medium">
        <?= settings.Login_Subtitle || 'Portal Absensi & Administrasi Terpadu' ?>
      </p>
    </div>

<form onsubmit="handleLogin(event)" class="space-y-5">
  
  <div class="group relative">
    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
      <i class="far fa-user text-slate-400 group-focus-within:text-blue-600 transition-colors"></i>
    </div>
    <input 
      type="text" 
      id="loginNip" 
      class="block w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 text-sm font-semibold placeholder-slate-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-300" 
      placeholder="NIP / NUPTK" 
      required 
      autocomplete="off">
  </div>

  <div class="group relative">
    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
      <i class="fas fa-lock text-slate-400 group-focus-within:text-blue-600 transition-colors"></i>
    </div>
    
    <input 
      type="password" 
      id="loginPass" 
      class="block w-full pl-11 pr-12 py-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 text-sm font-semibold placeholder-slate-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-300" 
      placeholder="Kata Sandi" 
      required>

    <div class="absolute inset-y-0 right-0 pr-2 flex items-center">
      <button 
        type="button" 
        onclick="togglePasswordVisibility()" 
        class="p-2 rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition-all focus:outline-none cursor-pointer"
        title="Tampilkan/Sembunyikan Password">
        <i class="fas fa-eye" id="iconEye"></i>
      </button>
    </div>
  </div>

  <button type="submit" id="btnLogin" class="w-full relative overflow-hidden bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transform transition hover:-translate-y-1 active:translate-y-0 duration-200 flex items-center justify-center gap-2 group">
    <span class="relative z-10">MASUK APLIKASI</span>
    <i class="fas fa-arrow-right relative z-10 group-hover:translate-x-1 transition-transform"></i>
    <div class="absolute inset-0 h-full w-full scale-0 rounded-xl transition-all duration-300 group-hover:scale-100 group-hover:bg-white/10"></div>
  </button>

</form>
    
    <div class="mt-8 pt-6 border-t border-slate-100 text-center">
      <p class="text-[11px] text-slate-400 font-medium">
        &copy; 2026 Management System V3.4 Enterprise<br>
        <span class="opacity-70">Keamanan Data Terjamin & Terenkripsi</span>
      </p>
    </div>
  </div>
</section>

  <div id="mainLayout" class="hidden-section flex h-screen overflow-hidden relative">
    
    <div id="mobileBackdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/60 z-20 hidden md:hidden transition-opacity backdrop-blur-sm"></div>

    <aside id="mainSidebar" class="fixed inset-y-0 left-0 z-30 w-72 sidebar-gradient text-slate-300 flex flex-col shadow-2xl transition-all duration-300 ease-in-out transform -translate-x-full md:translate-x-0 md:relative font-sans">
      
      <div class="h-20 flex items-center px-6 border-b border-slate-700/50 bg-slate-900/50 backdrop-blur-sm">
        <div class="flex items-center gap-3 w-full">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
            <i class="fas fa-school text-lg"></i>
          </div>
          <div class="logo-text overflow-hidden">
            <h1 class="font-bold text-white text-lg tracking-tight leading-tight">SIM-K PTK</h1>
            <p class="text-[10px] text-slate-400 font-medium tracking-wider uppercase">Sistem Manajemen</p>
          </div>
        </div>
        <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto custom-scrollbar">
        
        <div id="menuAdmin" class="hidden-section">
          <p class="nav-text text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-3 px-2 mt-2">Administrator</p>
          
          <div onclick="showPage('adminDashboard')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Dashboard">
            <i class="fas fa-home w-5 text-center transition group-hover:scale-110"></i> 
            <span class="nav-text">Dashboard</span>
          </div>
          
          <div onclick="showPage('adminDataPTK')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Data PTK">
            <i class="fas fa-users w-5 text-center transition group-hover:scale-110"></i> 
            <span class="nav-text">Data Pegawai (PTK)</span>
          </div>
          
          <div onclick="showPage('adminRekap')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Rekap Absensi">
            <i class="fas fa-chart-bar w-5 text-center transition group-hover:scale-110"></i> 
            <span class="nav-text">Rekap Absensi</span>
          </div>

          <div onclick="showPage('pageJadwalPiket')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Atur Jadwal Piket">
             <i class="fas fa-calendar-alt w-5 text-center transition group-hover:scale-110"></i> 
             <span class="nav-text">Jadwal Piket</span>
          </div>

          <div onclick="showPage('adminApproval')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Persetujuan Izin">
            <i class="fas fa-check-circle w-5 text-center transition group-hover:scale-110"></i> 
            <span class="nav-text">Approval Izin</span>
          </div>

          <div onclick="showPage('adminSettings')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Konfigurasi">
            <i class="fas fa-sliders-h w-5 text-center transition group-hover:scale-110"></i> 
            <span class="nav-text">Pengaturan Sistem</span>
          </div>
        </div>
        
        <div id="menuPTK" class="hidden-section">
          <div onclick="openAbsenModal()" class="mb-6 mx-1 p-4 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg shadow-blue-500/20 cursor-pointer transform transition hover:scale-[1.02] group relative overflow-hidden">
             <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2">
                 <i class="fas fa-camera text-6xl"></i>
             </div>
             <div class="relative z-10 flex items-center gap-3">
                 <div class="bg-white/20 p-2 rounded-lg"><i class="fas fa-fingerprint text-xl"></i></div>
                 <div>
                     <h4 class="font-bold text-sm">Absen Sekarang</h4>
                     <p class="text-[10px] text-blue-100">Klik untuk scan wajah</p>
                 </div>
             </div>
          </div>

          <p class="nav-text text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-3 px-2">Menu Utama</p>
          
          <div onclick="showPage('ptkDashboard')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Dashboard">
            <i class="fas fa-th-large w-5 text-center transition group-hover:scale-110"></i> 
            <span class="nav-text">Dashboard</span>
          </div>
          
          <div onclick="showPage('ptkIzin')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Izin / Sakit">
            <i class="fas fa-envelope-open-text w-5 text-center transition group-hover:scale-110"></i> 
            <span class="nav-text">Pengajuan Izin</span>
          </div>

          <div onclick="showPage('ptkRekap')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Riwayat Absen">
            <i class="fas fa-history w-5 text-center transition group-hover:scale-110"></i> 
            <span class="nav-text">Riwayat Absensi</span>
          </div>

          <div onclick="showPage('pageJadwalPiket')" class="nav-item group cursor-pointer flex items-center gap-3 p-3 text-sm font-medium" title="Jadwal Piket">
             <i class="fas fa-calendar-day w-5 text-center transition group-hover:scale-110"></i> 
             <span class="nav-text">Info Piket</span>
          </div>
       </div>
      </nav>

      <div class="p-4 border-t border-slate-700/50 bg-slate-900/80">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold border-2 border-slate-600" id="userAvatar">U</div>
          <div class="profile-text overflow-hidden">
            <p class="text-sm font-bold text-white truncate" id="userName">User Name</p>
            <p class="text-xs text-slate-400 truncate" id="userRole">Role</p>
          </div>
        </div>
        <button onclick="logout()" class="w-full py-2 px-4 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-2 text-xs font-bold border border-red-500/20">
          <i class="fas fa-power-off"></i> <span>KELUAR</span>
        </button>
      </div>
    </aside>

    <div class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-50">
      
      <header class="h-20 bg-white/80 backdrop-blur-md sticky top-0 z-20 flex items-center justify-between px-6 shadow-sm border-b border-slate-200">
         <div class="flex items-center gap-4">
          <button onclick="toggleSidebar()" class="p-2 rounded-lg text-slate-500 hover:bg-slate-100 hover:text-blue-600 transition focus:outline-none md:hidden">
            <i class="fas fa-bars text-xl"></i>
          </button>
          
          <div>
            <h1 class="text-lg font-bold text-slate-800 tracking-tight" id="headerTitle">Dashboard</h1>
            <p class="hidden md:block text-xs text-slate-500 font-medium" id="headerDate">Hari ini</p>
           </div>
        </div>

        <div class="flex items-center gap-4">
          <div class="md:hidden flex items-center gap-2">
             <button onclick="logout()" class="text-red-500 p-2 hover:bg-red-50 rounded-full transition"><i class="fas fa-sign-out-alt text-lg"></i></button>
          </div>
        </div>
      </header>

      <main class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar" id="contentArea">
        
        <div id="adminDashboard" class="page-content hidden-section animate-fade-in pb-10">
           <div class="mb-8 bg-white rounded-2xl p-6 shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
              <div>
                  <h2 class="text-2xl font-bold text-slate-800" id="adminGreeting">Selamat Datang, Admin!</h2>
                  <p class="text-slate-500 text-sm mt-1">Berikut adalah ringkasan aktivitas sekolah hari ini.</p>
              </div>
              <div class="flex items-center gap-3 bg-slate-50 px-4 py-2 rounded-xl border border-slate-100">
                  <i class="far fa-calendar-alt text-blue-500"></i>
                  <span class="text-sm font-semibold text-slate-700" id="currentDateDisplayAdmin">Hari ini</span>
              </div>
           </div>

           <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-5 relative overflow-hidden group">
              <div class="flex justify-between items-start z-10 relative">
                <div>
                   <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Pegawai</p>
                   <h3 class="text-3xl font-bold text-slate-800" id="statTotalPTK">-</h3>
                </div>
                <div class="stat-card-icon bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                    <i class="fas fa-users text-xl"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-xs text-slate-400 font-medium">
                 <span class="text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded mr-2">Data</span> Terdaftar
              </div>
            </div>
            <div class="glass-card p-5 relative overflow-hidden group">
              <div class="flex justify-between items-start z-10 relative">
                <div>
                   <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Hadir Tepat Waktu</p>
                   <h3 class="text-3xl font-bold text-emerald-600" id="statHadir">-</h3>
                </div>
                <div class="stat-card-icon bg-emerald-50 text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                   <i class="fas fa-check-circle text-xl"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-xs text-slate-400 font-medium">
                 <span class="text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded mr-2">Absen</span> Masuk hari ini
              </div>
            </div>
            <div class="glass-card p-5 relative overflow-hidden group">
              <div class="flex justify-between items-start z-10 relative">
                <div>
                   <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Terlambat</p>
                   <h3 class="text-3xl font-bold text-orange-500" id="statTelat">-</h3>
                </div>
                <div class="stat-card-icon bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                   <i class="fas fa-clock text-xl"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-xs text-slate-400 font-medium">
                 <span class="text-orange-600 bg-orange-50 px-1.5 py-0.5 rounded mr-2">Telat</span> Lewat batas
              </div>
            </div>
            <div class="glass-card p-5 relative overflow-hidden group">
              <div class="flex justify-between items-start z-10 relative">
                <div>
                   <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Pulang Cepat</p>
                   <h3 class="text-3xl font-bold text-rose-500" id="statPulangCepat">-</h3>
                </div>
                <div class="stat-card-icon bg-rose-50 text-rose-600 group-hover:bg-rose-600 group-hover:text-white transition-colors">
                   <i class="fas fa-running text-xl"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-xs text-slate-400 font-medium">
                 <span class="text-rose-600 bg-rose-50 px-1.5 py-0.5 rounded mr-2">Info</span> Sebelum waktunya
              </div>
            </div>
           </div>
          
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
              <div class="flex items-center gap-3">
                   <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i class="fas fa-stream"></i></div>
                   <h3 class="font-bold text-slate-800 text-lg">Aktivitas Absensi Terkini</h3>
              </div>
              <div class="flex flex-col sm:flex-row items-center gap-2 w-full md:w-auto">
                <select id="recentRowsPerPage" onchange="changeRecentRows()" class="bg-slate-50 border border-slate-200 text-slate-600 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none font-medium transition hover:bg-slate-100">
                  <option value="10">10 Baris</option>
                  <option value="25">25 Baris</option>
                  <option value="50">50 Baris</option>
                </select>
                 <div class="relative w-full sm:w-60">
                  <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <i class="fas fa-search text-slate-400 text-xs"></i>
                  </div>
                  <input type="text" id="recentSearchInput" onkeyup="handleRecentSearch()" class="bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-9 p-2.5 outline-none transition focus:bg-white" placeholder="Cari nama pegawai...">
                </div>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                  <tr>
                    <th class="p-4 whitespace-nowrap">Pegawai</th>
                    <th class="p-4 whitespace-nowrap">Aktivitas</th>
                    <th class="p-4 whitespace-nowrap">Waktu</th>
                    <th class="p-4 whitespace-nowrap">Status</th>
                    <th class="p-4 whitespace-nowrap">Lokasi</th> 
                  </tr>
                </thead>
                <tbody id="adminRecentTable" class="divide-y divide-slate-100">
                    <tr><td colspan="5" class="p-10 text-center text-slate-400 flex flex-col items-center justify-center gap-2"><i class="fas fa-circle-notch fa-spin text-2xl text-blue-500"></i><span>Sedang memuat data...</span></td></tr>
                </tbody>
              </table>
            </div>
            <div class="bg-slate-50 px-5 py-3 border-t border-slate-200 flex flex-col sm:flex-row items-center justify-between gap-4">
               <span class="text-xs text-slate-500 font-medium" id="recentPageInfo">Menampilkan 0 - 0 dari 0</span>
              <div class="inline-flex rounded-lg shadow-sm isolate">
                 <button onclick="prevRecentPage()" id="btnPrevRecent" class="relative inline-flex items-center rounded-l-lg px-3 py-2 text-xs font-bold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"><i class="fas fa-chevron-left mr-1"></i> Prev</button>
                  <button onclick="nextRecentPage()" id="btnNextRecent" class="relative -ml-px inline-flex items-center rounded-r-lg px-3 py-2 text-xs font-bold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition">Next <i class="fas fa-chevron-right ml-1"></i></button>
              </div>
            </div>
          </div>
        </div>

        <div id="adminDataPTK" class="page-content hidden-section animate-fade-in">
          <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
              <i class="fas fa-users text-blue-600"></i> Manajemen Pegawai
            </h2>
            <button onclick="openPTKModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-blue-500/30 flex items-center gap-2 text-sm font-bold transition transform hover:scale-105">
              <i class="fas fa-plus"></i> Tambah Baru
            </button>
          </div>

          <div class="bg-white p-5 rounded-t-2xl border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
            <div class="flex items-center gap-3 text-sm text-slate-600">
              <select id="ptkRowsPerPage" onchange="changePTKRows()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                 <option value="all">Semua</option>
              </select>
              <span>per halaman</span>
            </div>
            <div class="relative w-full md:w-64">
              <input type="text" id="ptkSearchInput" onkeyup="handlePTKSearch()" class="bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2 outline-none transition" placeholder="Cari Nama atau NIP...">
              <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
            </div>
          </div>

           <div class="bg-white shadow-sm border border-slate-200 border-t-0 overflow-hidden rounded-b-2xl">
             <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 uppercase text-xs">
                  <tr>
                    <th class="p-4">Nama Lengkap</th>
                    <th class="p-4">NIP/NUPTK</th>
                    <th class="p-4">Jabatan</th>
                    <th class="p-4">Status</th>
                    <th class="p-4 text-center">Aksi</th>
                  </tr>
                </thead>
                <tbody id="tablePTKBody" class="divide-y divide-slate-100">
                  <tr><td colspan="5" class="p-8 text-center text-slate-400"><i class="fas fa-circle-notch fa-spin"></i> Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="bg-slate-50 px-5 py-3 border-t border-slate-200 flex flex-col sm:flex-row items-center justify-between gap-4">
              <span class="text-sm text-slate-600" id="ptkPageInfo">Menampilkan 0 - 0 dari 0</span>
              <div class="inline-flex rounded-md shadow-sm isolate">
                <button onclick="prevPTKPage()" id="btnPrevPTK" class="relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 transition">Prev</button>
                <button onclick="nextPTKPage()" id="btnNextPTK" class="relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 transition">Next</button>
              </div>
             </div>
          </div>
        </div>

<div id="adminRekap" class="page-content hidden-section animate-fade-in">
          <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
              <i class="fas fa-chart-bar text-indigo-600"></i> Rekapitulasi Absensi
             </h2>
            <div class="flex gap-2">
                <button onclick="downloadExcelRekap()" id="btnDownloadExcel" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl shadow-lg shadow-emerald-500/20 flex items-center gap-2 text-sm font-bold transition">
                  <i class="fas fa-file-excel"></i> Excel
               </button>
                <button onclick="window.print()" class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-xl shadow-sm flex items-center gap-2 text-sm font-bold transition">
                  <i class="fas fa-print"></i> Cetak
                </button>
            </div>
          </div>

          <div class="bg-white p-5 rounded-t-2xl border-b border-slate-100 flex flex-col lg:flex-row justify-between items-center gap-4 shadow-sm">
            <div class="flex items-center gap-2 text-sm text-slate-600 w-full lg:w-auto">
              <select id="rekapRowsPerPage" onchange="changeRekapRows()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
             </select>
             <span>baris</span>
            </div>

            <div class="flex flex-col md:flex-row gap-2 w-full lg:w-auto items-center">
               
               <div class="relative w-full md:w-48">
                  <select id="filterRekapPTK" onchange="handleRekapSearch()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 outline-none">
                      <option value="all">-- Semua Pegawai --</option>
                      <option disabled>Memuat data...</option>
                  </select>
               </div>

               <input type="date" id="rekapStartDate" onchange="handleRekapSearch()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 outline-none">
                
               <span class="text-slate-400 hidden md:block">-</span>
                
               <input type="date" id="rekapEndDate" onchange="handleRekapSearch()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 outline-none">
                
               <div class="relative w-full md:w-64">
                  <input type="text" id="rekapSearchInput" onkeyup="handleRekapSearch()" class="bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-9 p-2 outline-none transition" placeholder="Cari Nama / NIP...">
                  <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
               </div>
            </div>
          </div>

          <div class="bg-white shadow-sm border border-slate-200 border-t-0 overflow-hidden rounded-b-2xl">
             <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 uppercase text-xs">
                  <tr>
                    <th class="p-4 whitespace-nowrap">Tanggal</th>
                    <th class="p-4 whitespace-nowrap">NIP</th>
                    <th class="p-4 whitespace-nowrap">Nama</th>
                    <th class="p-4 whitespace-nowrap bg-emerald-50/50 text-emerald-700 border-l border-slate-200">Jam Masuk</th>
                    <th class="p-4 whitespace-nowrap bg-emerald-50/50 text-emerald-700">Status</th>
                    <th class="p-4 whitespace-nowrap bg-emerald-50/50 text-center text-emerald-700">Foto</th>
                    <th class="p-4 whitespace-nowrap bg-emerald-50/50 text-emerald-700">Lokasi</th>
                    <th class="p-4 whitespace-nowrap bg-blue-50/50 text-blue-700 border-l border-slate-200">Jam Pulang</th>
                    <th class="p-4 whitespace-nowrap bg-blue-50/50 text-blue-700">Status</th>
                    <th class="p-4 whitespace-nowrap bg-blue-50/50 text-center text-blue-700">Foto</th>
                    <th class="p-4 whitespace-nowrap bg-blue-50/50 text-blue-700">Lokasi</th>
                    <th class="p-4 whitespace-nowrap border-l border-slate-200">Lokasi Tugas</th>
                  </tr>
                </thead>
                <tbody id="tableRekapBody" class="divide-y divide-slate-100">
                   <tr><td colspan="12" class="p-8 text-center text-slate-400">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="bg-slate-50 px-5 py-3 border-t border-slate-200 flex flex-col sm:flex-row items-center justify-between gap-4">
              <span class="text-sm text-slate-600" id="rekapPageInfo">Menampilkan 0 - 0 dari 0</span>
              <div class="inline-flex rounded-md shadow-sm isolate">
                <button onclick="prevRekapPage()" id="btnPrevRekap" class="relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 transition">Prev</button>
                <button onclick="nextRekapPage()" id="btnNextRekap" class="relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 transition">Next</button>
              </div>
            </div>
          </div>
        </div>
   
        <div id="adminApproval" class="page-content hidden-section animate-fade-in">
          <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
              <i class="fas fa-check-double text-purple-600"></i> Persetujuan Izin
            </h2>
            <button onclick="loadApprovalList()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-xl shadow-sm flex items-center gap-2 text-sm font-bold transition">
              <i class="fas fa-sync-alt"></i> Segarkan Data
            </button>
           </div>

          <div class="bg-white p-5 rounded-t-2xl border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
            <div class="flex items-center gap-2 text-sm text-slate-600">
               <select id="approvalRowsPerPage" onchange="changeApprovalRows()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="all">Semua</option>
              </select>
             </div>
            <div class="relative w-full md:w-72">
              <input type="text" id="approvalSearchInput" onkeyup="handleApprovalSearch()" class="bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2 outline-none transition" placeholder="Cari Nama, Jenis Izin...">
              <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
            </div>
          </div>

          <div class="bg-white shadow-sm border border-slate-200 border-t-0 overflow-hidden rounded-b-2xl">
              <div class="overflow-x-auto">
               <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 uppercase text-xs">
                  <tr>
                    <th class="p-4 whitespace-nowrap">Tgl Pengajuan</th>
                    <th class="p-4 whitespace-nowrap">Nama Pegawai</th>
                    <th class="p-4 whitespace-nowrap">Jenis & Ket</th>
                     <th class="p-4 whitespace-nowrap">Periode</th>
                    <th class="p-4 text-center whitespace-nowrap">File Bukti</th>
                    <th class="p-4 text-center whitespace-nowrap">Aksi</th>
                  </tr>
                </thead>
                <tbody id="tableApprovalBody" class="divide-y divide-slate-100">
                  <tr><td colspan="6" class="p-8 text-center text-slate-400">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="bg-slate-50 px-5 py-3 border-t border-slate-200 flex flex-col sm:flex-row items-center justify-between gap-4">
              <span class="text-sm text-slate-600" id="approvalPageInfo">Menampilkan 0 - 0 dari 0</span>
              <div class="inline-flex rounded-md shadow-sm isolate">
                <button onclick="prevApprovalPage()" id="btnPrevApproval" class="relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 transition">Prev</button>
                <button onclick="nextApprovalPage()" id="btnNextApproval" class="relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 transition">Next</button>
              </div>
            </div>
           </div>
        </div>

        <div id="pageJadwalPiket" class="page-content hidden-section animate-fade-in">
          
          <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
              <i class="fas fa-calendar-check text-pink-600"></i> Jadwal Piket
            </h2>
            <div id="adminPiketControls" class="hidden flex gap-2">
                <button id="btnBulkDeletePiket" onclick="handleBulkDeletePiket()" class="hidden bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-xl shadow flex items-center gap-2 text-sm font-bold transition">
                  <i class="fas fa-trash-alt"></i> Hapus (<span id="countPiketDelete">0</span>)
                </button>
                <button onclick="openModalPiket()" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-xl shadow-lg shadow-pink-500/20 flex items-center gap-2 text-sm font-bold transition transform hover:scale-105">
                  <i class="fas fa-plus"></i> Tambah Petugas
              </button>
            </div>
          </div>

          <div class="bg-white p-4 rounded-t-2xl border-b border-slate-100 flex items-center gap-4 shadow-sm overflow-x-auto">
            <span class="text-sm font-bold text-slate-600 whitespace-nowrap">Filter Hari:</span>
            <div class="flex gap-2" id="filterHariContainer">
               <button onclick="filterPiket('Semua')" class="filter-btn-hari bg-blue-600 text-white px-3 py-1 rounded-full text-xs transition font-bold shadow-md">Semua</button>
               <button onclick="filterPiket('Senin')" class="filter-btn-hari bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1 rounded-full text-xs transition font-medium">Senin</button>
               <button onclick="filterPiket('Selasa')" class="filter-btn-hari bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1 rounded-full text-xs transition font-medium">Selasa</button>
               <button onclick="filterPiket('Rabu')" class="filter-btn-hari bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1 rounded-full text-xs transition font-medium">Rabu</button>
               <button onclick="filterPiket('Kamis')" class="filter-btn-hari bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1 rounded-full text-xs transition font-medium">Kamis</button>
               <button onclick="filterPiket('Jumat')" class="filter-btn-hari bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1 rounded-full text-xs transition font-medium">Jumat</button>
              <button onclick="filterPiket('Sabtu')" class="filter-btn-hari bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1 rounded-full text-xs transition font-medium">Sabtu</button>
              <button onclick="filterPiket('Minggu')" class="filter-btn-hari bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1 rounded-full text-xs transition font-medium">Minggu</button>
            </div>
          </div>

          <div class="bg-white shadow-sm border border-slate-200 border-t-0 overflow-hidden rounded-b-2xl">
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                 <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 uppercase text-xs">
                  <tr>
                     <th class="p-4 w-10 text-center admin-col hidden">
                        <input type="checkbox" id="checkAllPiket" onchange="toggleSelectAllPiket(this)" class="rounded text-pink-600 focus:ring-pink-500 cursor-pointer w-4 h-4 border-slate-300">
                    </th>
                    <th class="p-4">Hari</th>
                    <th class="p-4">Nama Petugas</th>
                    <th class="p-4">Tugas / Posisi</th>
                    <th class="p-4">Lokasi</th>
                    <th class="p-4 text-center admin-col hidden">Aksi</th>
                  </tr>
                </thead>
                <tbody id="tablePiketBody" class="divide-y divide-slate-100">
                   <tr><td colspan="6" class="p-8 text-center text-slate-400">Memuat jadwal...</td></tr>
                </tbody>
              </table>
             </div>
         </div>
        </div>

<div id="adminSettings" class="page-content hidden-section animate-fade-in">
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
      <i class="fas fa-sliders-h text-slate-600"></i> Konfigurasi Sistem
    </h2>
    <button onclick="submitSystemSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl shadow-lg flex items-center gap-2 text-sm font-bold transition transform active:scale-95">
      <i class="fas fa-save"></i> SIMPAN PERUBAHAN
    </button>
  </div>

  <form id="formSettings" onsubmit="event.preventDefault();" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-fit">
      <h3 class="text-lg font-bold text-slate-800 border-b border-slate-100 pb-3 mb-4"><i class="fas fa-paint-brush text-blue-500 mr-2"></i>Tampilan & Branding</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Nama Aplikasi</label>
          <input type="text" name="App_Name" id="set_App_Name" class="w-full p-2.5 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Contoh: Sistem Absensi Guru">
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Subtitle Login</label>
          <input type="text" name="Login_Subtitle" id="set_Login_Subtitle" class="w-full p-2.5 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Contoh: Masuk menggunakan akun sekolah">
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">URL Logo Sekolah</label>
          <input type="text" name="App_Logo" id="set_App_Logo" class="w-full p-2.5 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="https://...">
          <p class="text-xs text-slate-400 mt-1">Gunakan link gambar langsung (akhiran .png/.jpg)</p>
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">URL Background Login</label>
          <input type="text" name="Login_Bg" id="set_Login_Bg" class="w-full p-2.5 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="https://...">
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
      
      <h3 class="text-lg font-bold text-slate-800 border-b border-slate-100 pb-3 mb-4">
        <i class="fas fa-calendar-alt text-green-500 mr-2"></i>Jadwal Mingguan & Hari Libur
      </h3>
      
      <div class="overflow-x-auto mb-6">
        <table class="w-full text-sm text-left border-collapse">
          <thead class="bg-slate-50 text-slate-600 font-bold uppercase text-xs">
            <tr>
              <th class="p-3 border-b border-slate-200">Hari</th>
              <th class="p-3 border-b border-slate-200 text-center">Libur?</th>
              <th class="p-3 border-b border-slate-200">Jam Masuk <span class="text-[10px] normal-case block text-slate-400">(Awal - Akhir)</span></th>
              <th class="p-3 border-b border-slate-200">Jam Pulang <span class="text-[10px] normal-case block text-slate-400">(Awal - Akhir)</span></th>
            </tr>
          </thead>
          <tbody id="tbodyJadwalSettings" class="divide-y divide-slate-100">
             <tr><td colspan="4" class="p-4 text-center text-slate-400 italic">Memuat jadwal...</td></tr>
          </tbody>
        </table>
        <p class="text-xs text-slate-400 mt-2 italic">* Centang "Libur" agar sistem tidak mencatat Alpha otomatis pada hari tersebut.</p>
      </div>

      <div class="mb-6 p-4 bg-red-50 rounded-xl border border-red-100">
          <h4 class="font-bold text-sm text-red-800 mb-3 flex items-center gap-2">
             <i class="fas fa-calendar-check"></i> Hari Libur Khusus / Nasional
          </h4>
          
          <div class="flex flex-col sm:flex-row gap-2 mb-4">
             <input type="date" id="inputLiburDate" class="p-2 border border-red-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-red-300 w-full sm:w-auto">
             <input type="text" id="inputLiburDesc" placeholder="Keterangan (Misal: Idul Fitri)" class="flex-1 p-2 border border-red-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-red-300">
             <button type="button" onclick="tambahLibur()" class="bg-red-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-red-700 transition flex items-center justify-center">
                <i class="fas fa-plus"></i>
             </button>
          </div>

          <div class="max-h-40 overflow-y-auto bg-white rounded border border-red-100 scrollbar-thin scrollbar-thumb-red-200">
             <table class="w-full text-xs text-left">
                <thead class="bg-red-100 text-red-800 font-bold sticky top-0">
                   <tr>
                      <th class="p-2 w-24">Tanggal</th>
                      <th class="p-2">Keterangan</th>
                      <th class="p-2 text-right w-10">Aksi</th>
                   </tr>
                </thead>
                <tbody id="tbodyLiburNasional" class="divide-y divide-red-50">
                   </tbody>
             </table>
             <p id="emptyLiburMsg" class="text-center text-slate-400 py-4 italic hidden">Belum ada data libur khusus.</p>
          </div>
      </div>

      <div class="space-y-4 pt-4 border-t border-slate-200">
        <div class="flex justify-between items-end mb-2">
            <h4 class="font-bold text-sm text-slate-700">
              <i class="fas fa-map-marker-alt text-red-500 mr-1"></i> Lokasi Sekolah
            </h4>
            <button type="button" onclick="getCurrentLocationAdmin()" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1.5 rounded-lg font-bold transition flex items-center gap-2 border border-blue-200">
              <i class="fas fa-crosshairs"></i> Ambil Lokasi Saya
            </button>
        </div>
        
        <div id="mapPicker" class="w-full h-64 rounded-xl border-2 border-slate-200 shadow-inner z-0"></div>

        <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-slate-500 mb-1">Latitude</label>
              <input type="text" name="Lat_Sekolah" id="set_Lat_Sekolah" class="w-full p-2 rounded-lg border border-slate-300 bg-slate-100 outline-none font-mono text-sm text-slate-600" readonly placeholder="-6.xxxxx">
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Longitude</label>
              <input type="text" name="Lng_Sekolah" id="set_Lng_Sekolah" class="w-full p-2 rounded-lg border border-slate-300 bg-slate-100 outline-none font-mono text-sm text-slate-600" readonly placeholder="106.xxxxx">
            </div>
        </div>
        
        <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Radius Absensi (Meter)</label>
            <div class="flex items-center gap-2">
             <input type="number" name="Radius_Meter" id="set_Radius_Meter" class="w-full p-2.5 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="100">
              <span class="text-slate-500 text-sm font-medium">Meter</span>
            </div>
        </div>
      </div>
    </div>

  </form>
</div>

        <div id="ptkDashboard" class="page-content hidden-section animate-fade-in pb-20">
          
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
              <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Halo, <span id="ptkNameDisplay" class="text-blue-600">Guru</span>! </h2>
              <p class="text-sm text-slate-500 font-medium mt-1">Siap untuk mengajar dan menginspirasi hari ini?</p>
            </div>
            <div class="text-xs font-bold bg-white text-slate-600 px-4 py-2 rounded-full border border-slate-200 shadow-sm flex items-center gap-2">
              <i class="far fa-clock text-blue-500"></i> <span id="currentDateDisplay">Hari ini</span>
            </div>
          </div>

           <div id="piketAlertCard" class="hidden mb-8 bg-gradient-to-r from-pink-500 to-rose-500 rounded-2xl shadow-lg shadow-pink-500/20 text-white p-1 relative overflow-hidden animate-fade-in">
              <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                   <i class="fas fa-bullhorn text-8xl"></i>
              </div>
              <div class="bg-white/10 backdrop-blur-sm rounded-xl p-5 flex items-center gap-4 relative z-10">
                  <div class="bg-white text-pink-500 w-12 h-12 rounded-full flex items-center justify-center shadow-lg flex-shrink-0 animate-pulse-soft">
                      <i class="fas fa-bell text-xl"></i>
                  </div>
                  <div>
                      <h4 class="font-bold text-lg leading-tight">Jadwal Piket Hari Ini!</h4>
                      <p class="text-pink-100 text-sm mt-1">
                        Anda bertugas: <span class="font-bold bg-white/20 px-2 py-0.5 rounded text-white" id="piketTugasDisplay">...</span> 
                        di <span class="font-bold bg-white/20 px-2 py-0.5 rounded text-white" id="piketLokasiDisplay">...</span>
                      </p>
                  </div>
              </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <div class="bg-white rounded-3xl p-6 shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 relative overflow-hidden group hover:border-blue-200 transition-all duration-300">
              <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity transform group-hover:scale-110 duration-500">
                <i class="fas fa-sun text-8xl text-blue-600"></i>
              </div>
              <div class="relative z-10">
                  <div class="flex items-center gap-2 mb-4">
                      <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-sign-in-alt"></i></div>
                      <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Kehadiran Pagi</span>
                  </div>
                  <div class="flex items-baseline gap-2 mb-2">
                    <h3 class="text-5xl font-bold text-slate-800 tracking-tighter" id="statusMasukTime">--:--</h3>
                    <span class="text-lg text-slate-400 font-light"><?= zonaWaktu ?></span>
                  </div>
                  <div id="statusMasukKet" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-500 text-xs font-bold border border-slate-200">
                      <i class="fas fa-circle text-[8px]"></i> Belum Absen
                  </div>
                  <button onclick="openAbsenModal()" class="mt-6 w-full py-3 rounded-xl bg-slate-900 text-white font-bold text-sm hover:bg-blue-600 transition shadow-lg shadow-slate-200 group-hover:shadow-blue-200">
                      Scan Absen Masuk
                  </button>
              </div>
            </div>
            <div class="bg-white rounded-3xl p-6 shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 relative overflow-hidden group hover:border-indigo-200 transition-all duration-300">
              <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity transform group-hover:scale-110 duration-500">
                 <i class="fas fa-moon text-8xl text-indigo-600"></i>
              </div>
              <div class="relative z-10">
                  <div class="flex items-center gap-2 mb-4">
                      <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><i class="fas fa-sign-out-alt"></i></div>
                      <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Kepulangan</span>
                  </div>
                  <div class="flex items-baseline gap-2 mb-2">
                    <h3 class="text-5xl font-bold text-slate-800 tracking-tighter" id="statusPulangTime">--:--</h3>
                      <span class="text-lg text-slate-400 font-light"><?= zonaWaktu ?></span>
                  </div>
                   <div id="statusPulangKet" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-500 text-xs font-bold border border-slate-200">
                      <i class="fas fa-circle text-[8px]"></i> Belum Absen
                  </div>
                  <button onclick="openAbsenModal()" class="mt-6 w-full py-3 rounded-xl bg-white border-2 border-slate-200 text-slate-700 font-bold text-sm hover:border-indigo-600 hover:text-indigo-600 transition">
                      Scan Absen Pulang
                  </button>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
              <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                <i class="fas fa-history text-slate-400"></i> Riwayat Kehadiran
               </h3>
               <div class="relative w-full md:w-64">
                <input type="text" id="historySearchInput" onkeyup="handleHistorySearch()" class="bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 p-2.5 outline-none transition" placeholder="Cari tanggal atau status...">
                <i class="fas fa-search absolute right-3 top-3 text-slate-400 text-xs"></i>
              </div>
            </div>
            <div class="overflow-x-auto">
                 <table class="w-full text-sm">
                  <thead class="bg-slate-50 text-slate-500 text-left text-xs font-bold uppercase tracking-wider border-b border-slate-200">
                    <tr>
                      <th class="p-4">Tanggal</th>
                      <th class="p-4 text-center">Masuk</th>
                      <th class="p-4">Status</th>
                      <th class="p-4 text-center">Pulang</th>
                      <th class="p-4">Status</th>
                      <th class="p-4 text-center">Bukti</th>
                    </tr>
                  </thead>
                  <tbody id="ptkHistoryTable" class="divide-y divide-slate-100">
                    <tr><td colspan="6" class="p-8 text-center text-slate-400">Memuat data...</td></tr>
                  </tbody>
                </table>
            </div>
             <div class="bg-slate-50 px-5 py-3 border-t border-slate-200 flex flex-col sm:flex-row items-center justify-between gap-4">
                  <span class="text-xs text-slate-500 font-medium" id="historyPageInfo">Menampilkan 0 - 0 dari 0</span>
                <div class="inline-flex rounded-lg shadow-sm isolate">
                  <select id="historyRowsPerPage" onchange="changeHistoryRows()" class="bg-white border border-slate-200 text-slate-600 text-xs rounded-l-lg p-2 mr-2 outline-none font-bold">
                      <option value="10">10</option>
                      <option value="25">25</option>
                  </select>
                  <button onclick="prevHistoryPage()" id="btnPrevHistory" class="relative inline-flex items-center rounded-l-lg px-3 py-2 text-xs font-bold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 transition"><i class="fas fa-chevron-left mr-1"></i></button>
                  <button onclick="nextHistoryPage()" id="btnNextHistory" class="relative -ml-px inline-flex items-center rounded-r-lg px-3 py-2 text-xs font-bold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 transition"><i class="fas fa-chevron-right ml-1"></i></button>
                </div>
              </div>
          </div>
        </div>

        <div id="ptkIzin" class="page-content hidden-section animate-fade-in pb-10">
          <div class="flex items-center gap-3 mb-6">
            <button onclick="showPage('ptkDashboard')" class="bg-white p-2.5 rounded-full shadow hover:bg-slate-50 text-slate-600 transition"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-2xl font-bold text-slate-800">Formulir Izin & Sakit</h2>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
             <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
              <form onsubmit="handleIzinSubmit(event)">
                <div class="mb-4">
                  <label class="block text-sm font-bold text-slate-700 mb-2">Jenis Pengajuan</label>
                   <select id="izinJenis" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" required>
                    <option value="">-- Pilih --</option>
                    <option value="Sakit">Sakit</option>
                    <option value="Izin Pribadi">Izin Pribadi</option>
                     <option value="Cuti">Cuti</option>
                    <option value="Dinas Luar">Dinas Luar</option>
                  </select>
               </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                   <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Mulai Tanggal</label>
                    <input type="date" id="izinMulai" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" required>
                  </div>
                   <div>
                     <label class="block text-sm font-bold text-slate-700 mb-2">Sampai Tanggal</label>
                    <input type="date" id="izinSelesai" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" required>
                   </div>
                </div>

                 <div class="mb-4">
                   <label class="block text-sm font-bold text-slate-700 mb-2">Alasan / Keterangan</label>
                   <textarea id="izinKet" rows="3" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" placeholder="Jelaskan alasan pengajuan..." required></textarea>
                </div>

                 <div class="mb-6">
                   <label class="block text-sm font-bold text-slate-700 mb-2">Bukti Pendukung</label>
                   <div class="relative">
                      <input type="file" id="izinFile" accept="image/*,application/pdf" class="w-full p-2 border border-slate-300 rounded-xl text-sm file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition bg-slate-50">
                   </div>
                  <p class="text-xs text-slate-400 mt-1">*Foto Surat Dokter / Surat Izin (Max 2MB)</p>
                 </div>

                 <button type="submit" id="btnKirimIzin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition transform active:scale-95 flex items-center justify-center gap-2">
                   <i class="fas fa-paper-plane"></i> KIRIM PENGAJUAN
                </button>
              </form>
             </div>

             <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
               <div class="p-5 border-b border-slate-100 bg-slate-50 font-bold text-slate-700 flex items-center gap-2">
                 <i class="fas fa-history text-slate-400"></i> Riwayat Pengajuan Saya
              </div>
               <div class="flex-1 overflow-y-auto max-h-[500px] custom-scrollbar">
                  <table class="w-full text-sm text-left">
                  <thead class="bg-white text-slate-500 sticky top-0 shadow-sm border-b border-slate-100 uppercase text-xs">
                     <tr>
                      <th class="p-4">Tanggal</th>
                      <th class="p-4">Jenis</th>
                      <th class="p-4">Status</th>
                    </tr>
                  </thead>
                  <tbody id="tableIzinHistory" class="divide-y divide-slate-100">
                     <tr><td colspan="3" class="p-6 text-center text-slate-400">Belum ada data.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="ptkRekap" class="page-content hidden-section animate-fade-in">
          <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
              <i class="fas fa-file-invoice text-cyan-600"></i> Rekap Kehadiran Saya
            </h2>
            <button onclick="window.print()" class="bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 px-4 py-2 rounded-xl shadow-sm flex items-center gap-2 text-sm font-bold transition">
               <i class="fas fa-print"></i> Cetak PDF
            </button>
          </div>

          <div class="bg-white p-5 rounded-t-2xl border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
             <div class="flex items-center gap-2 text-sm font-bold text-slate-600 w-full md:w-auto">
                 <i class="fas fa-filter text-slate-400"></i> Filter Periode:
             </div>
             <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto items-center">
                <div class="relative w-full md:w-auto">
                    <input type="date" id="ptkRekapStart" onchange="handlePTKRekapFilter()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2 outline-none">
                </div>
                <span class="text-slate-400 hidden md:block">s.d.</span>
                <div class="relative w-full md:w-auto">
                    <input type="date" id="ptkRekapEnd" onchange="handlePTKRekapFilter()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2 outline-none">
               </div>
              </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-cyan-50/50 p-6 border border-cyan-100 border-t-0 border-b-0">
             <div class="text-center p-2 rounded-lg hover:bg-white/50 transition">
                <span class="block text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Hadir</span>
                <span id="ptkStatHadir" class="text-2xl font-bold text-slate-800">0</span>
              </div>
             <div class="text-center p-2 rounded-lg hover:bg-white/50 transition">
                <span class="block text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Terlambat</span>
                <span id="ptkStatTelat" class="text-2xl font-bold text-orange-600">0</span>
             </div>
              <div class="text-center p-2 rounded-lg hover:bg-white/50 transition">
                 <span class="block text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Plg Cepat</span>
                <span id="ptkStatCepat" class="text-2xl font-bold text-red-600">0</span>
             </div>
             <div class="text-center p-2 rounded-lg hover:bg-white/50 transition">
                 <span class="block text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Izin/Sakit</span>
                <span id="ptkStatIzin" class="text-2xl font-bold text-purple-600">0</span>
              </div>
          </div>

          <div class="bg-white p-4 border border-slate-200 border-t-0 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2 text-sm text-slate-600 w-full md:w-auto">
                 <select id="ptkRekapRows" onchange="changePTKRekapRows()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2 outline-none">
                 <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="all">Semua</option>
              </select>
               <span>baris</span>
            </div>
            <div class="relative w-full md:w-64">
               <input type="text" id="ptkRekapSearch" onkeyup="handlePTKRekapSearch()" class="bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full pl-10 p-2 outline-none transition" placeholder="Cari status...">
               <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
            </div>
          </div>

          <div class="bg-white shadow-sm border border-slate-200 border-t-0 overflow-hidden rounded-b-2xl">
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                 <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 uppercase text-xs">
                   <tr>
                    <th class="p-4 whitespace-nowrap">Tanggal</th>
                    <th class="p-4 whitespace-nowrap">Jam Masuk</th>
                    <th class="p-4 whitespace-nowrap">Status</th>
                    <th class="p-4 whitespace-nowrap">Jam Pulang</th>
                    <th class="p-4 whitespace-nowrap">Status</th>
                    <th class="p-4 whitespace-nowrap">Lokasi Tugas</th>
                  </tr>
                 </thead>
                <tbody id="tablePTKRekapBody" class="divide-y divide-slate-100">
                   <tr><td colspan="6" class="p-8 text-center text-slate-400">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
             <div class="bg-slate-50 px-5 py-3 border-t border-slate-200 flex flex-col sm:flex-row items-center justify-between gap-4">
               <span class="text-sm text-slate-600" id="ptkRekapPageInfo">Menampilkan 0 - 0 dari 0</span>
              <div class="inline-flex rounded-md shadow-sm isolate">
                 <button onclick="prevPTKRekapPage()" id="btnPrevPTKRekap" class="relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 transition">Prev</button>
                <button onclick="nextPTKRekapPage()" id="btnNextPTKRekap" class="relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50 transition">Next</button>
              </div>
             </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <div id="modalAbsen" class="fixed inset-0 z-50 bg-slate-900/90 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0">
    <div class="w-full max-w-md bg-white rounded-3xl overflow-hidden relative shadow-2xl animate-scale-up border border-slate-200">
      <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <h3 class="font-bold text-lg text-slate-800"><i class="fas fa-camera text-blue-500 mr-2"></i>Ambil Foto</h3>
        <button onclick="closeAbsenModal()" class="text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="relative bg-black h-80 flex items-center justify-center overflow-hidden">
        <video id="cameraFeed" autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video> 
        <canvas id="cameraCanvas" class="hidden"></canvas>
        <div class="absolute inset-0 border-2 border-white/20 rounded-2xl m-6 pointer-events-none flex items-center justify-center">
            <span class="text-white/70 text-xs bg-black/60 px-3 py-1 rounded-full backdrop-blur-md">Posisikan Wajah di Tengah</span>
         </div>
      </div>

      <div class="p-6 space-y-5 bg-white">
        <div class="grid grid-cols-2 gap-4">
          <label class="cursor-pointer group">
             <input type="radio" name="jenisAbsen" value="Absen Masuk" class="peer hidden" checked>
             <div class="p-3 rounded-2xl border-2 border-slate-100 peer-checked:border-green-500 peer-checked:bg-green-50 text-center transition group-hover:border-slate-200">
              <i class="fas fa-sun text-2xl mb-1 text-slate-300 peer-checked:text-green-600 block transition-colors"></i>
              <span class="font-bold text-slate-500 peer-checked:text-green-700 text-sm">MASUK</span>
            </div>
          </label>
           <label class="cursor-pointer group">
            <input type="radio" name="jenisAbsen" value="Absen Pulang" class="peer hidden">
            <div class="p-3 rounded-2xl border-2 border-slate-100 peer-checked:border-blue-500 peer-checked:bg-blue-50 text-center transition group-hover:border-slate-200">
               <i class="fas fa-moon text-2xl mb-1 text-slate-300 peer-checked:text-blue-600 block transition-colors"></i>
              <span class="font-bold text-slate-500 peer-checked:text-blue-700 text-sm">PULANG</span>
             </div>
           </label>
        </div>

        <div id="locationStatus" class="flex items-center justify-center gap-2 text-xs py-3 px-4 bg-slate-50 rounded-xl border border-slate-100 text-slate-500 font-medium">
          <i class="fas fa-spinner fa-spin"></i> <span>Mencari koordinat GPS...</span>
        </div>

        <button id="btnCapture" onclick="captureAndSubmit()" class="w-full bg-slate-900 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-slate-300 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none transition-all transform active:scale-95 flex items-center justify-center gap-2 text-sm" disabled>
           <i class="fas fa-paper-plane"></i> KIRIM ABSENSI
        </button>
      </div>
    </div>
  </div>

  <div id="modalPTK" class="fixed inset-0 z-50 bg-slate-900/80 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm transition-opacity">
    <div class="w-full max-w-lg bg-white rounded-3xl overflow-hidden shadow-2xl animate-scale-up border border-slate-200">
      
      <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center">
        <h3 class="font-bold text-lg text-slate-800" id="modalPTKTitle">
          <i class="fas fa-user-plus text-blue-600 mr-2"></i> Tambah Pegawai
        </h3>
        <button onclick="closePTKModal()" class="text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form onsubmit="handlePTKSubmit(event)" class="p-6 space-y-4 max-h-[80vh] overflow-y-auto custom-scrollbar">
        <input type="hidden" id="ptkIsEdit" name="isEdit" value="false">
        <input type="hidden" id="ptkNipLama" name="nipLama" value="">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP / NUPTK</label>
            <input type="number" id="inputNip" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" placeholder="Contoh: 123456" required>
          </div>
          <div>
             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label>
              <input type="text" id="inputNama" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" placeholder="Nama User" required>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jabatan</label>
             <input type="text" id="inputJabatan" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" placeholder="Contoh: Guru Kelas" required>
          </div>
        
           <div>
             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lokasi Tugas</label>
             <input type="text" id="inputLokasi" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" placeholder="Contoh: Kantor / Kelas A">
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Role Akses</label>
             <select id="inputRole" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition">
              <option value="PTK">PTK (User Biasa)</option>
              <option value="ADMIN">Administrator</option>
             </select>
          </div>
          <div>
             <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status Akun</label>
             <select id="inputStatus" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition">
              <option value="Aktif">Aktif</option>
              <option value="Nonaktif">Nonaktif</option>
             </select>
          </div>
         </div>

        <div>
           <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password Login</label>
           <div class="relative">
              <input type="text" id="inputPassword" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition" placeholder="Password akun..." required>
           </div>
           <p class="text-[10px] text-slate-400 mt-1 ml-1">*Password disimpan sebagai teks biasa (mudah diingat user)</p>
        </div>

        <div class="pt-4 border-t border-slate-100">
           <button type="submit" id="btnSavePTK" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition transform active:scale-95 flex items-center justify-center gap-2">
            <i class="fas fa-save"></i> SIMPAN DATA
          </button>
        </div>
       </form>
    </div>
  </div>

  <div id="modalPiket" class="fixed inset-0 z-50 bg-slate-900/80 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm transition-opacity">
    <div class="w-full max-w-lg bg-white rounded-3xl overflow-hidden shadow-2xl animate-scale-up max-h-[90vh] flex flex-col border border-slate-200">
      
      <div class="p-5 bg-white border-b border-slate-100 flex justify-between items-center shrink-0">
         <h3 class="font-bold text-lg text-slate-800" id="modalPiketTitle">
           <i class="fas fa-calendar-plus text-pink-600 mr-2"></i> Kelola Jadwal
        </h3>
        <button onclick="document.getElementById('modalPiket').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form onsubmit="handlePiketSubmit(event)" class="p-6 space-y-4 overflow-y-auto custom-scrollbar">
         <div>
           <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Petugas</label>
           <div class="relative">
               <select id="piketNip" class="w-full p-3 pl-10 rounded-xl border border-slate-300 bg-slate-50 outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition appearance-none" onchange="setPiketNama()" required>
                 <option value="">-- Pilih PTK --</option>
               </select>
               <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-user text-slate-400"></i>
               </div>
               <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                  <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
               </div>
           </div>
           <input type="hidden" id="piketNamaHidden">
        </div>

        <div class="border-t border-slate-100 my-2"></div>

        <div>
           <label class="block text-sm font-bold text-slate-700 mb-2">Jadwal Tugas & Lokasi</label>
           <p class="text-xs text-slate-400 mb-3">Centang hari untuk mengisi detail tugas spesifik.</p>
           
           <div id="containerHariDynamic" class="space-y-3">
              <div class="text-center py-6 text-slate-400 text-sm italic bg-slate-50 rounded-xl border border-dashed border-slate-300">
                 <i class="fas fa-circle-notch fa-spin mr-2"></i> Memuat form hari...
              </div>
           </div>
        </div>

        <button type="submit" id="btnSavePiket" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-pink-500/30 mt-4 transition transform active:scale-95 flex items-center justify-center gap-2 shrink-0">
           <i class="fas fa-save"></i> SIMPAN JADWAL
        </button>
      </form>
    </div>
  </div>


<script>
    // ==========================================================
    // 1. VARIABEL GLOBAL & STATE MANAGEMENT
    // ==========================================================
    let currentUser = null;
    let userLocation = { lat: null, lng: null };
    let adminMap = null;     // Variabel penampung Peta
    let adminMarker = null;  // Variabel penampung Pin/Marker
    let adminCircle = null;
    let userTodayStatus = { masuk: false, pulang: false };
    // Setup Tanggal Hari Ini
    const today = new Date();
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    const dateString = today.toLocaleDateString('id-ID', options);
    const listHari = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"];
    if(document.getElementById("currentDateDisplay")) document.getElementById("currentDateDisplay").innerText = dateString;
    if(document.getElementById("headerDate")) document.getElementById("headerDate").innerText = dateString;

    // --- State Data & Pagination ---

    // Data PTK
    let allPTKData = [];
    let filteredPTKData = [];
    let currentPTKPage = 1;
    let ptkRowsPerPage = 10;

    // Rekap Absensi
    let allRekapData = [];
    let filteredRekapData = [];
    let currentRekapPage = 1;
    let rekapRowsPerPage = 10;

    // Approval Izin
    let allApprovalData = [];
    let filteredApprovalData = [];
    let currentApprovalPage = 1;
    let approvalRowsPerPage = 10;

    // Jadwal Piket (BARU)
    let allPiketData = [];

    // Aktivitas Terkini (Admin)
    let allRecentData = [];
    let filteredRecentData = [];
    let currentRecentPage = 1;
    let recentRowsPerPage = 10;

    // Riwayat PTK (User)
    let allHistoryData = [];
    let filteredHistoryData = [];
    let currentHistoryPage = 1;
    let historyRowsPerPage = 10;

    let allPTKReportData = [];
    let filteredPTKRekapData = []; // Data setelah difilter Tanggal & Search
    let currentPTKRekapPage = 1;
    let ptkRekapRowsPerPage = 10;

    
    // ==========================================================
    // 2. UI UTILITIES & NAVIGATION
    // ==========================================================

    function toggleSidebar() {
      const sidebar = document.getElementById('mainSidebar');
      const backdrop = document.getElementById('mobileBackdrop');
      const isMobile = window.innerWidth < 768;

      if (isMobile) {
        if (sidebar.classList.contains('-translate-x-full')) {
          sidebar.classList.remove('-translate-x-full');
          backdrop.classList.remove('hidden');
        } else {
          sidebar.classList.add('-translate-x-full');
          backdrop.classList.add('hidden');
        }
      } else {
        const isCollapsed = sidebar.classList.toggle('sidebar-collapsed');
        if (isCollapsed) {
          sidebar.classList.remove('w-64');
          sidebar.classList.add('w-20');
        } else {
          sidebar.classList.remove('w-20');
          sidebar.classList.add('w-64');
        }
      }
    }

    function closeSidebarMobile() {
      if (window.innerWidth < 768) {
         const sidebar = document.getElementById('mainSidebar');
         const backdrop = document.getElementById('mobileBackdrop');
         sidebar.classList.add('-translate-x-full');
         backdrop.classList.add('hidden');
      }
    }

    function updateHeaderTitle(pageId) {
      const titleMap = {
        'adminDashboard': 'Dashboard Administrator',
        'adminDataPTK': 'Manajemen Data PTK',
        'adminRekap': 'Rekapitulasi Absensi',
        'adminApproval': 'Persetujuan Izin',
        'pageJadwalPiket': 'Jadwal Piket Petugas', // Title Baru
        'ptkRekap': 'Laporan Kehadiran',
        'ptkDashboard': 'Dashboard Utama',
        'ptkIzin': 'Formulir Izin & Sakit'
      };
      const titleEl = document.getElementById('headerTitle');
      if(titleEl) {
        titleEl.style.opacity = 0;
        setTimeout(() => {
            titleEl.innerText = titleMap[pageId] || 'Sistem Absensi';
            titleEl.style.opacity = 1;
        }, 200);
      }
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById("toast");
      const text = document.getElementById("toastMsg");
      const icon = toast.querySelector("i");
      
      text.innerText = msg;
      toast.classList.remove("hidden");
      toast.classList.remove("translate-y-[-20px]", "opacity-0");
      
      if (isError) {
          toast.classList.replace("border-blue-500", "border-red-500");
          icon.className = "fas fa-exclamation-circle text-red-500 mr-3 text-xl";
      } else {
          toast.classList.replace("border-red-500", "border-blue-500");
          icon.className = "fas fa-info-circle text-blue-500 mr-3 text-xl";
      }

      setTimeout(() => {
        toast.classList.add("translate-y-[-20px]", "opacity-0");
        setTimeout(() => toast.classList.add("hidden"), 300);
      }, 3000);
    }

    function formatDateShort(val) {
       if (!val) return "-";
       const d = new Date(val);
       if (isNaN(d.getTime())) return val; 
       return d.toLocaleDateString('id-ID');
    }

    function runInit(event) {
      const btn = event.target;
      const originalText = btn.innerText;
      if(!confirm("PERHATIAN: Proses ini akan mengecek atau membuat ulang struktur database. Lanjutkan?")) return;
      btn.innerText = "Memproses...";
      btn.disabled = true;

      google.script.run.withSuccessHandler(res => {
        alert(res);
        btn.innerText = originalText;
        btn.disabled = false;
      }).initialize();
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById("loginPass"); // Pastikan ID ini sama dengan input
        const icon = document.getElementById("iconEye");

        if (passwordInput.type === "password") {
            passwordInput.type = "text";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
            icon.parentElement.classList.add("text-blue-600");
        } else {
            passwordInput.type = "password";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
            icon.parentElement.classList.remove("text-blue-600");
        }
    }
    // ==========================================================
    // 3. AUTENTIKASI (LOGIN / LOGOUT)
    // ==========================================================

function handleLogin(e) {
    e.preventDefault();
    
    const nip = document.getElementById("loginNip").value;
    const pass = document.getElementById("loginPass").value;
    const btn = document.getElementById("btnLogin");
    const originalBtnContent = btn.innerHTML;
    
    // Ubah tombol menjadi loading
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MEMERIKSA...';
    btn.disabled = true;

    google.script.run.withSuccessHandler(res => {
      // Kembalikan tombol ke kondisi semula
      btn.innerHTML = originalBtnContent;
      btn.disabled = false;
      
      if (res.success) {
        // --- SECURITY UPDATE: SIMPAN TOKEN ---
        // Simpan token yang diterima dari server ke Local Storage browser
        if (res.token) {
            localStorage.setItem("authToken", res.token);
        }
        
        // Simpan data user ke variabel global
        currentUser = res.data;

        // Setup UI dasar (Nama, Sidebar, Role)
        setupUI(currentUser);
        
        // --- UPDATE PENTING: PRELOAD DATA ---
        // Panggil fungsi ini agar data (PTK/Rekap/Piket) langsung dimuat.
        // Jadi saat user klik menu, tidak perlu loading lagi (Instan).
        preloadAppData(currentUser);
        // ------------------------------------
        
        // --- UI TRANSITION (Login -> Dashboard) ---
        const loginSec = document.getElementById("loginSection");
        
        // Efek Fade Out Login
        loginSec.style.transition = 'opacity 0.5s ease';
        loginSec.style.opacity = '0';
        
        setTimeout(() => {
            // Sembunyikan Login Section sepenuhnya
            loginSec.classList.add("hidden-section");
            loginSec.style.display = 'none'; 
            
            // Tampilkan Main Layout (Dashboard)
            document.getElementById("mainLayout").classList.remove("hidden-section");
            
            // Tampilkan notifikasi sukses kecil
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true
            });
            Toast.fire({ icon: 'success', title: 'Login Berhasil' });

        }, 500); // Waktu delay sesuai durasi transisi CSS (0.5s)
        
      } else {
        // Jika Gagal (Password salah / Akun nonaktif)
        showToast(res.message, true);
      }
    }).loginUser(nip, pass);
}

function logout() {
      Swal.fire({
        title: 'Konfirmasi Keluar',
        text: "Apakah Anda yakin ingin keluar?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Keluar',
        cancelButtonText: 'Batal',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
            
            // --- SECURITY UPDATE: HAPUS TOKEN ---
            // Wajib hapus token agar sesi benar-benar berakhir di sisi client
            localStorage.removeItem("authToken"); 
            
            // 1. Reset Variabel Global
            currentUser = null;
            userLocation = { lat: null, lng: null };
            
            // 2. Reset Form Login
            document.getElementById("loginNip").value = "";
            document.getElementById("loginPass").value = "";
            
            // 3. Reset Tampilan Menu & Halaman
            // Sembunyikan menu Admin & PTK
            document.getElementById("menuAdmin").classList.add("hidden-section");
            document.getElementById("menuPTK").classList.add("hidden-section");
            
            // Sembunyikan semua halaman konten
            const allPages = document.querySelectorAll('.page-content');
            allPages.forEach(page => page.classList.add('hidden-section'));

            // 4. Transisi Tampilan (Main -> Login)
            const mainLayout = document.getElementById("mainLayout");
            const loginSec = document.getElementById("loginSection");
            
            mainLayout.classList.add("hidden-section");
            loginSec.classList.remove("hidden-section");
            loginSec.style.display = 'flex'; 
            
            // Efek Fade In Login
            loginSec.style.opacity = '0';
            setTimeout(() => {
                loginSec.style.transition = 'opacity 0.5s ease';
                loginSec.style.opacity = '1';
            }, 10);

            // 5. Reset Sidebar (untuk Mobile/Desktop)
            const sidebar = document.getElementById('mainSidebar');
            const backdrop = document.getElementById('mobileBackdrop');
            if (sidebar) {
                 sidebar.classList.add('-translate-x-full'); // Tutup sidebar mobile
                 sidebar.classList.remove('sidebar-collapsed'); 
                 sidebar.classList.remove('w-20');
                 sidebar.classList.add('w-64');
            }
            if (backdrop) backdrop.classList.add('hidden');
            
            // 6. Notifikasi Sukses
            const Toast = Swal.mixin({
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true
            });
            Toast.fire({
              icon: 'success',
              title: 'Berhasil keluar'
            });
        }
      });
    }


    // ==========================================================
    // 4. ROUTING HALAMAN
    // ==========================================================

    function setupUI(user) {
      document.querySelectorAll("#userName").forEach(el => el.innerText = user.nama);
      document.querySelectorAll("#userRole").forEach(el => el.innerText = user.jabatan);
      document.getElementById("userAvatar").innerText = user.nama.charAt(0).toUpperCase();
      
      if(document.getElementById("ptkNameDisplay")) {
          document.getElementById("ptkNameDisplay").innerText = user.nama.split(" ")[0];
      }
      
      if (user.role === "ADMIN") {
        document.getElementById("menuAdmin").classList.remove("hidden-section");
        showPage('adminDashboard');
      } else {
        document.getElementById("menuPTK").classList.remove("hidden-section");
        showPage('ptkDashboard');
      }
    }

// ==========================================================
// FUNGSI BARU: PRELOAD DATA (MUAT SEMUA DI AWAL)
// ==========================================================
function preloadAppData(user) {
    console.log("Memulai pre-load data untuk: " + user.role);

    if (user.role === "ADMIN") {
        // Panggil semua fungsi load Admin secara paralel
        // Cek flag agar tidak double request jika fungsi dipanggil berulang
        if(allRecentData.length === 0) loadAdminData();
        if(allPTKData.length === 0) loadDataPTK();
        if(allRekapData.length === 0) loadDataRekap();
        if(allApprovalData.length === 0) loadApprovalList();
        if(allPiketData.length === 0) loadJadwalPiket();
    } else {
        // Panggil fungsi load untuk User Biasa (PTK)
        // Kita panggil Dashboard & History
        loadPTKData(); // Ini sudah memuat dashboard stats & history sekaligus
        loadIzinHistory();
        loadPTKRekapPage();
        if(allPiketData.length === 0) loadJadwalPiket();
    }
}
// ==========================================================
    // BAGIAN I: KONFIGURASI SISTEM (ADMIN)
    // ==========================================================

    // 1. Load Settings Saat Halaman Dibuka & Terapkan Tampilan
    document.addEventListener("DOMContentLoaded", function() {
       // Load tampilan visual (Logo, Background)
       loadVisualSettings();
       
       // CEK TOKEN LOCALSTORAGE SEBELUM MENENTUKAN TAMPILAN
       const token = localStorage.getItem("authToken");

       if (!token) {
           // KASUS 1: Tidak ada token (User Tamu/Belum Login)
           // Matikan Loader -> Tampilkan Login
           hideLoaderAndShow("loginSection");
       } else {
           // KASUS 2: Ada token (Kemungkinan User Login)
           // Biarkan Loader tetap menyala, panggil server untuk verifikasi
           checkAutoLogin(token);
       }
    });

// Fungsi Transisi Halus dari Loader
    function hideLoaderAndShow(targetId) {
        const loader = document.getElementById("initialLoader");
        const target = document.getElementById(targetId);
        
        // Fade out loader
        loader.style.opacity = '0';
        
        setTimeout(() => {
            loader.classList.add("hidden-section"); // Hilangkan loader
            if(target) {
                target.classList.remove("hidden-section"); // Munculkan Login atau Dashboard
                
                // Khusus Login, kita beri efek fade in agar cantik
                if(targetId === 'loginSection') {
                    target.style.opacity = 0;
                    target.style.display = 'flex';
                    setTimeout(() => target.style.opacity = 1, 50);
                }
            }
        }, 500); // Sesuaikan dengan duration-500 di CSS loader
    }

    function loadVisualSettings() {
      google.script.run.withSuccessHandler(settings => {
         if(!settings) return;

         // A. Update Tampilan Halaman Login (Real-time)
         const loginCard = document.querySelector('.login-header-title');
         const loginDesc = document.querySelector('.login-header-desc');
         const logoImg = document.querySelector('.logo-img');
         const loginContainer = document.querySelector('.login-container');

         // 1. Ganti Judul Aplikasi
         if(settings.App_Name && loginCard) {
             loginCard.innerText = settings.App_Name;
             document.title = settings.App_Name; // Judul Tab Browser
         }
         
         // 2. Ganti Subtitle
         if(settings.Login_Subtitle && loginDesc) {
             loginDesc.innerText = settings.Login_Subtitle;
         }

         // 3. Ganti Logo
         if(settings.App_Logo && logoImg) {
             logoImg.src = settings.App_Logo;
         }

         // 4. Ganti Background
         if(settings.Login_Bg && loginContainer) {
             // Pastikan URL valid agar tidak blank
             if(settings.Login_Bg.startsWith('http')) {
                loginContainer.style.backgroundImage = `url('${settings.Login_Bg}')`;
             }
         }

      }).getAppSettings();
    }

    // 2. Fungsi Load Data ke Form Admin (Dipanggil saat menu diklik)
function loadSettingsPage() {
   // 1. Daftar ID Input Standar (Visual & Lokasi)
   // CATATAN: Input Jam Masuk/Pulang dihapus dari sini karena sekarang ditangani oleh Tabel Jadwal
   const inputs = [
      "App_Name", "Login_Subtitle", "App_Logo", "Login_Bg",
      "Lat_Sekolah", "Lng_Sekolah", "Radius_Meter"
   ];
   
   // 2. Set Status "Loading..." pada input standar agar user tahu proses sedang berjalan
   inputs.forEach(id => {
      const el = document.getElementById("set_" + id);
      if(el) el.value = "...";
   });

   // 3. Minta Data Settings dari Server
   google.script.run.withSuccessHandler(settings => {
      if (!settings) return; 

      // A. Isi Form Input Standar (Teks & Lokasi)
      inputs.forEach(id => {
         const el = document.getElementById("set_" + id);
         if(el) {
            el.value = settings[id] || "";
         }
      });

      // B. RENDER TABEL JADWAL MINGGUAN
      // Fungsi ini akan mengisi tabel Senin-Minggu dengan data jam/libur
      if (typeof renderJadwalSettings === 'function') {
          renderJadwalSettings(settings);
      }

      // C. LOAD DAFTAR HARI LIBUR NASIONAL (UPDATE BARU)
      // Memanggil fungsi terpisah untuk mengambil data dari sheet "HariLibur"
      if (typeof loadHolidays === 'function') {
          loadHolidays();
      }

      // D. INISIALISASI PETA
      if (typeof initMapAdmin === 'function') {
          // Beri jeda sedikit agar nilai Lat/Lng sudah masuk ke input sebelum peta dirender
          setTimeout(() => { 
              initMapAdmin(); 
          }, 300);
      }

   }).getAppSettings();
}

    // 3. Fungsi Simpan Pengaturan
function submitSystemSettings() {
    const btn = document.querySelector("button[onclick='submitSystemSettings()']");
    const originalText = btn.innerHTML;

    // --- 1. AMBIL TOKEN SECURITY ---
    const token = localStorage.getItem("authToken");

    // Cek apakah token ada
    if (!token) {
        Swal.fire({
            icon: 'error',
            title: 'Sesi Berakhir',
            text: 'Silakan login ulang untuk menyimpan perubahan.'
        }).then(() => logout());
        return;
    }

    // --- 2. UI LOADING ---
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MENYIMPAN...';
    btn.disabled = true;

    // --- 3. AMBIL DATA FORM (UPDATE BARU) ---
    
    // A. Siapkan Data Jadwal Harian (Dari Tabel)
    const days = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"];
    const jadwalPayload = {};

    days.forEach(hari => {
        // Ambil elemen input berdasarkan ID yang digenerate oleh renderJadwalSettings
        const isLibur = document.getElementById(`libur_${hari}`).checked;
        const ma = document.getElementById(`ma_${hari}`).value; // Masuk Awal
        const mk = document.getElementById(`mk_${hari}`).value; // Masuk Akhir
        const pa = document.getElementById(`pa_${hari}`).value; // Pulang Awal
        const pk = document.getElementById(`pk_${hari}`).value; // Pulang Akhir

        // Bungkus jadi object kecil
        const dataHari = {
            libur: isLibur,
            masuk_awal: ma,
            masuk_akhir: mk,
            pulang_awal: pa,
            pulang_akhir: pk
        };

        // Simpan sebagai JSON String dengan key "Jadwal_Senin", dst.
        jadwalPayload[`Jadwal_${hari}`] = JSON.stringify(dataHari);
    });

    // B. Gabungkan dengan Data Visual & Lokasi
    const payload = {
        // --- DATA VISUAL ---
        App_Name: document.getElementById("set_App_Name").value,
        Login_Subtitle: document.getElementById("set_Login_Subtitle").value,
        App_Logo: document.getElementById("set_App_Logo").value,
        Login_Bg: document.getElementById("set_Login_Bg").value,
        
        // --- DATA LOKASI ---
        Lat_Sekolah: document.getElementById("set_Lat_Sekolah").value,
        Lng_Sekolah: document.getElementById("set_Lng_Sekolah").value,
        Radius_Meter: document.getElementById("set_Radius_Meter").value,

        // --- DATA JADWAL (Spread Operator untuk menggabungkan object jadwal ke payload utama) ---
        ...jadwalPayload
    };

    // --- 4. KIRIM KE SERVER DENGAN TOKEN ---
    google.script.run.withSuccessHandler(res => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showToast(res.message, !res.success);
        
        if(res.success) {
            // Refresh tampilan visual (Nama App/Logo) agar admin langsung melihat perubahan
            loadVisualSettings();
        }
    })
    .withFailureHandler(err => {
        // Handle error koneksi
        btn.innerHTML = originalText;
        btn.disabled = false;
        showToast("Gagal menyimpan: " + err.message, true);
    })
    .saveAppSettings(token, payload); // <--- Token dikirim sebagai parameter pertama
}

    // 4. Update Fungsi Routing (showPage)
    // Modifikasi fungsi showPage yang sudah ada untuk menghandle halaman settings
    const originalShowPage = showPage; // Simpan fungsi lama jika perlu referensi
    
    // Override/Update fungsi showPage di script utama Anda:
    // Cari fungsi showPage di script lama, dan tambahkan `else if` ini:
    /*
    else if (pageId === 'adminSettings') {
        loadSettingsPage();
    }
    */
    
    // Atau timpa fungsi showPage sepenuhnya dengan versi update di bawah ini:
function showPage(pageId) {
    // 1. Sembunyikan semua halaman konten
    document.querySelectorAll('.page-content').forEach(el => {
        el.classList.add('hidden-section'); // Tambah class hidden
    });
    
    // 2. Tampilkan halaman yang dituju
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.remove('hidden-section'); // Hapus class hidden
    }

    // 3. Update Judul Header & Tutup Sidebar Mobile
    // Pastikan fungsi updateHeaderTitle dan closeSidebarMobile sudah ada di kode Anda
    if (typeof updateHeaderTitle === 'function') updateHeaderTitle(pageId);
    if (typeof closeSidebarMobile === 'function') closeSidebarMobile();

    // ============================================================
    // 4. LOGIKA BARU: UPDATE STATUS AKTIF MENU SIDEBAR
    // ============================================================
    
    // A. Reset semua tombol menu ke kondisi normal (abu-abu/transparan)
    document.querySelectorAll('.nav-item').forEach(el => {
        // Hapus style aktif
        el.classList.remove('bg-white/20', 'text-white', 'shadow-md', 'border-l-4', 'border-blue-400');
        // Kembalikan ke style default (agak redup)
        el.classList.add('text-gray-300'); 
    });

    // B. Cari tombol menu yang memanggil pageId ini dan beri warna aktif
    // Selector ini mencari elemen dengan atribut onclick yang berisi nama halaman
    const activeLink = document.querySelector(`.nav-item[onclick*="'${pageId}'"]`);
    
    if (activeLink) {
        // Hapus style default
        activeLink.classList.remove('text-gray-300');
        // Tambahkan style aktif (Terang + Background transparan + Border kiri biru)
        activeLink.classList.add('bg-white/20', 'text-white', 'shadow-md', 'border-l-4', 'border-blue-400');
    }

    // ============================================================
    // 5. SMART LOADING (DATA LOGIC)
    // ============================================================
    
    // --- HALAMAN ADMIN ---
    if (pageId === 'adminDashboard') {
        // Hanya load jika data masih kosong untuk menghemat kuota
        if (typeof allRecentData !== 'undefined' && allRecentData.length === 0) loadAdminData();
    } 
    else if (pageId === 'adminDataPTK') {
        if (typeof allPTKData !== 'undefined' && allPTKData.length === 0) loadDataPTK();
        else renderPTKTable(); // Jika data sudah ada, render ulang saja
    } 
    else if (pageId === 'adminRekap') {
        if (typeof allRekapData !== 'undefined' && allRekapData.length === 0) loadDataRekap();
    } 
    else if (pageId === 'adminApproval') {
        if (typeof allApprovalData !== 'undefined' && allApprovalData.length === 0) loadApprovalList();
    } 
    else if (pageId === 'pageJadwalPiket') {
        if (typeof allPiketData !== 'undefined' && allPiketData.length === 0) loadJadwalPiket();
    } 
    
    // --- HALAMAN USER (PTK) ---
    else if (pageId === 'ptkDashboard') {
        if (typeof allHistoryData !== 'undefined' && allHistoryData.length === 0) loadPTKData();
    } 
    else if (pageId === 'ptkIzin') {
        const tableBody = document.getElementById("tableIzinHistory");
        // Cek jika tabel kosong atau masih loading
        if (tableBody && (tableBody.innerHTML.includes("Memuat") || tableBody.children.length === 0)) {
            loadIzinHistory();
        }
    } 
    else if (pageId === 'ptkRekap') {
        if (typeof allPTKReportData !== 'undefined' && allPTKReportData.length === 0) loadPTKRekapPage();
    } 
    
    // --- HALAMAN KONFIGURASI (SETTINGS) ---
    else if (pageId === 'adminSettings') {
        loadSettingsPage();

        // FIX MAP RENDERING:
        // Jika peta sudah pernah dimuat (adminMap ada), kita harus memaksa resize (invalidateSize)
        // karena peta baru saja berubah dari hidden (display:none) menjadi visible (block).
        if (typeof adminMap !== 'undefined' && adminMap) {
            setTimeout(() => { 
                adminMap.invalidateSize(); 
                
                // Opsional: Pastikan marker tetap di tengah setelah resize
                if (typeof adminMarker !== 'undefined') {
                    const centerPos = adminMarker.getLatLng();
                    adminMap.panTo(centerPos);
                }
            }, 500); // Delay 500ms agar transisi CSS selesai dulu baru peta dirender
        }
    }
}
    // ==========================================================
    // BAGIAN A: ADMIN - DASHBOARD & AKTIVITAS
    // ==========================================================

    function loadAdminData() {
      document.getElementById("statTotalPTK").innerText = "-";
      document.getElementById("statHadir").innerText = "-";
      document.getElementById("statTelat").innerText = "-";
      document.getElementById("statPulangCepat").innerText = "-";
      document.getElementById("adminRecentTable").innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin mr-2"></i> Memuat data...</td></tr>';
      
      if(document.getElementById("recentSearchInput")) document.getElementById("recentSearchInput").value = "";
      currentRecentPage = 1;

      google.script.run.withSuccessHandler(data => {
        document.getElementById("statTotalPTK").innerText = data.totalPTK;
        document.getElementById("statHadir").innerText = data.hadir;
        document.getElementById("statTelat").innerText = data.terlambat;
        document.getElementById("statPulangCepat").innerText = data.pulangCepat;
        
        allRecentData = (data.recentActivity && data.recentActivity.length > 0) ? data.recentActivity : [];
        filteredRecentData = allRecentData;
        renderRecentTable();

      }).getAdminDashboardData();
    }

    function renderRecentTable() {
        const tbody = document.getElementById("adminRecentTable");
        tbody.innerHTML = "";

        if (filteredRecentData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Belum ada aktivitas hari ini.</td></tr>';
            updateRecentPaginationInfo(0, 0, 0);
            return;
        }

        const totalItems = filteredRecentData.length;
        let start = (currentRecentPage - 1) * recentRowsPerPage;
        let end = start + recentRowsPerPage;
        if (recentRowsPerPage === 'all') { start = 0; end = totalItems; }

        const paginatedData = filteredRecentData.slice(start, end);
        paginatedData.forEach(row => {
            let statusBadge = "";
            let txt = row.status;
            
            if(txt.includes("Terlambat") || txt.includes("Telat")) {
                statusBadge = "bg-orange-100 text-orange-600 border border-orange-200";
            } else if(txt.includes("Cepat")) {
               statusBadge = "bg-red-50 text-red-600 border border-red-100";
            } else {
                statusBadge = "bg-green-100 text-green-600 border border-green-200";
            }
            let jenisBadge = row.jenis === "Masuk" ? "bg-green-100 text-green-600" : "bg-blue-100 text-blue-600";

            tbody.innerHTML += `
                <tr class="hover:bg-gray-50 transition border-b border-gray-100 last:border-0">
                    <td class="p-3 font-medium text-gray-700">${row.nama}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-[10px] ${jenisBadge} font-bold uppercase tracking-wider">${row.jenis}</span></td>
                    <td class="p-3 font-mono text-gray-600 text-xs font-semibold">${row.waktu}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${statusBadge}">${row.status}</span></td>
                    <td class="p-3 text-xs text-gray-500 truncate max-w-[150px]" title="${row.lokasi}">
                      ${row.lokasi ? `<i class="fas fa-map-marker-alt text-red-400 mr-1"></i> ${row.lokasi}` : '-'}
                    </td>
                </tr>`;
        });
        updateRecentPaginationInfo(start + 1, Math.min(end, totalItems), totalItems);
    }

    function updateRecentPaginationInfo(start, end, total) {
        document.getElementById("recentPageInfo").innerHTML = `Menampilkan <span class="font-bold text-gray-900">${total === 0 ? 0 : start}</span> - <span class="font-bold text-gray-900">${end}</span> dari <span class="font-bold text-gray-900">${total}</span>`;
        const btnPrev = document.getElementById("btnPrevRecent");
        const btnNext = document.getElementById("btnNextRecent");
        btnPrev.disabled = (currentRecentPage === 1);
        if (recentRowsPerPage === 'all') { btnNext.disabled = true; } 
        else { btnNext.disabled = (currentRecentPage >= Math.ceil(total / recentRowsPerPage)); }
    }

    function handleRecentSearch() {
        const query = document.getElementById("recentSearchInput").value.toLowerCase();
        filteredRecentData = allRecentData.filter(row => row.nama.toLowerCase().includes(query) || row.status.toLowerCase().includes(query));
        currentRecentPage = 1;
        renderRecentTable();
    }
    
    function changeRecentRows() {
        const val = document.getElementById("recentRowsPerPage").value;
        recentRowsPerPage = (val === 'all') ? 'all' : parseInt(val);
        currentRecentPage = 1;
        renderRecentTable();
    }
    function prevRecentPage() { if (currentRecentPage > 1) { currentRecentPage--; renderRecentTable(); } }
    function nextRecentPage() { 
        const maxPage = Math.ceil(filteredRecentData.length / recentRowsPerPage);
        if (recentRowsPerPage !== 'all' && currentRecentPage < maxPage) { currentRecentPage++; renderRecentTable(); } 
    }


    // ==========================================================
    // BAGIAN B: ADMIN - MANAJEMEN PTK
    // ==========================================================

    function loadDataPTK() {
      const tbody = document.getElementById("tablePTKBody");
      tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> Memuat data...</td></tr>';
      document.getElementById("ptkSearchInput").value = "";
      currentPTKPage = 1;

      // AMBIL TOKEN
      const token = localStorage.getItem("authToken");

      // KIRIM TOKEN
      google.script.run.withSuccessHandler(users => {
        allPTKData = users || [];
        filteredPTKData = users || []; 
        renderPTKTable();
      }).getPTKList(token); // <--- PERUBAHAN DISINI
    }

    function renderPTKTable() {
        const tbody = document.getElementById("tablePTKBody");
        tbody.innerHTML = "";

        if (filteredPTKData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">Data tidak ditemukan.</td></tr>';
            updatePaginationInfo(0, 0, 0);
            return;
        }

        const totalItems = filteredPTKData.length;
        let start = (currentPTKPage - 1) * ptkRowsPerPage;
        let end = start + ptkRowsPerPage;
        if (ptkRowsPerPage === 'all') { start = 0; end = totalItems; }

        const paginatedData = filteredPTKData.slice(start, end);
        paginatedData.forEach(user => {
          const dataString = JSON.stringify(user).replace(/"/g, '&quot;');
          tbody.innerHTML += `
            <tr class="hover:bg-blue-50/30 transition border-b border-gray-100">
              <td class="p-4 font-bold text-gray-700">${user.nama}</td>
              <td class="p-4 text-gray-500 font-mono text-sm hidden md:table-cell">${user.nip}</td>
              <td class="p-4 text-gray-600 text-sm">${user.jabatan}</td>
              <td class="p-4"><span class="px-2 py-1 rounded-full text-xs ${user.status === 'Aktif' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} font-bold">${user.status}</span></td>
              <td class="p-4 text-center">
                 <div class="flex items-center justify-center gap-2">
                    <button onclick="openPTKModal('edit', ${dataString})" class="bg-yellow-100 text-yellow-600 hover:bg-yellow-200 p-2 rounded-lg transition" title="Edit"><i class="fas fa-edit"></i></button>
                    <button onclick="hapusPTK('${user.nip}')" class="bg-red-100 text-red-600 hover:bg-red-200 p-2 rounded-lg transition" title="Hapus"><i class="fas fa-trash"></i></button>
                </div>
              </td>
            </tr>`;
        });
        updatePaginationInfo(start + 1, Math.min(end, totalItems), totalItems);
    }

    function updatePaginationInfo(start, end, total) {
        document.getElementById("ptkPageInfo").innerHTML = `Menampilkan <span class="font-bold text-gray-900">${total === 0 ? 0 : start}</span> sampai <span class="font-bold text-gray-900">${end}</span> dari <span class="font-bold text-gray-900">${total}</span> data`;
        const btnPrev = document.getElementById("btnPrevPTK");
        const btnNext = document.getElementById("btnNextPTK");
        btnPrev.disabled = (currentPTKPage === 1);
        if (ptkRowsPerPage === 'all') { btnNext.disabled = true; } 
        else { btnNext.disabled = (currentPTKPage >= Math.ceil(total / ptkRowsPerPage)); }
    }

    function handlePTKSearch() {
        const query = document.getElementById("ptkSearchInput").value.toLowerCase();
        filteredPTKData = allPTKData.filter(user => user.nama.toLowerCase().includes(query) || String(user.nip).includes(query) || user.jabatan.toLowerCase().includes(query));
        currentPTKPage = 1;
        renderPTKTable();
    }
    
    function changePTKRows() {
        const val = document.getElementById("ptkRowsPerPage").value;
        ptkRowsPerPage = (val === 'all') ? 'all' : parseInt(val);
        currentPTKPage = 1;
        renderPTKTable();
    }
    function prevPTKPage() { if (currentPTKPage > 1) { currentPTKPage--; renderPTKTable(); } }
    function nextPTKPage() { const maxPage = Math.ceil(filteredPTKData.length / ptkRowsPerPage); if (ptkRowsPerPage !== 'all' && currentPTKPage < maxPage) { currentPTKPage++; renderPTKTable(); } }

    function hapusPTK(nip) {
      Swal.fire({
        title: 'Hapus Data?',
        text: "PERINGATAN: Yakin ingin menghapus data PTK NIP " + nip + "?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33', // Merah untuk bahaya
        cancelButtonColor: '#3085d6', // Biru untuk batal
        confirmButtonText: 'Ya, Hapus!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          
          // 1. Tampilkan Loading saat proses berjalan
          Swal.fire({
            title: 'Memproses...',
            text: 'Sedang menghapus data.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
          });

          // 2. Ambil Token Security
          const token = localStorage.getItem("authToken");

          // 3. Panggil Server
          google.script.run.withSuccessHandler(res => {
            
            // Cek Error Sesi (Token Expired)
            if (res.message && (res.message.includes("Sesi Berakhir") || res.message.includes("Token") || res.message.includes("Akses Ditolak"))) {
              Swal.fire('Akses Ditolak', 'Sesi keamanan berakhir. Silakan login kembali.', 'error')
              .then(() => logout());
              return;
            }

            // Tampilkan Hasil (Sukses/Gagal) menggunakan SweetAlert juga
            if (res.success) {
              Swal.fire(
                'Terhapus!',
                res.message,
                'success'
              );
              loadDataPTK(); // Reload tabel
            } else {
              Swal.fire(
                'Gagal!',
                res.message,
                'error'
              );
            }
            
          }).deletePTK(token, nip);
        }
      });
    }


    function openPTKModal(mode, data = null) {
      const modal = document.getElementById("modalPTK");
      const title = document.getElementById("modalPTKTitle");
      const form = modal.querySelector("form");
      modal.classList.remove("hidden");
      form.reset();
      
      if (mode === 'edit' && data) {
        title.innerHTML = `<i class="fas fa-user-edit text-yellow-500 mr-2"></i> Edit Data PTK`;
        document.getElementById("ptkIsEdit").value = "true";
        document.getElementById("ptkNipLama").value = data.nip;
        document.getElementById("inputNip").value = data.nip;
        document.getElementById("inputNama").value = data.nama;
        document.getElementById("inputJabatan").value = data.jabatan;
        document.getElementById("inputLokasi").value = data.lokasi || "";
        document.getElementById("inputRole").value = data.role;
        document.getElementById("inputStatus").value = data.status;
        document.getElementById("inputPassword").placeholder = "Isi hanya jika ingin mengubah password";
        document.getElementById("inputPassword").required = false;
      } else {
        title.innerHTML = `<i class="fas fa-user-plus text-blue-600 mr-2"></i> Tambah PTK Baru`;
        document.getElementById("ptkIsEdit").value = "false";
        document.getElementById("ptkNipLama").value = "";
        document.getElementById("inputPassword").required = true;
        document.getElementById("inputPassword").placeholder = "Password akun...";
      }
    }

    function closePTKModal() { document.getElementById("modalPTK").classList.add("hidden"); }

function handlePTKSubmit(e) {
  e.preventDefault();
  const btn = document.getElementById("btnSavePTK");
  const originalText = btn.innerHTML;

  // --- 1. AMBIL TOKEN SECURITY ---
  const token = localStorage.getItem("authToken");

  // Jika token tidak ada (misal sesi habis/cache dihapus), paksa logout
  if (!token) {
    Swal.fire({
      icon: 'error',
      title: 'Sesi Berakhir',
      text: 'Silakan login ulang untuk melanjutkan.'
    }).then(() => logout());
    return;
  }

  // --- 2. UBAH TOMBOL JADI LOADING ---
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MENYIMPAN...';
  btn.disabled = true;

  // --- 3. SIAPKAN DATA (PAYLOAD) ---
  const payload = {
    isEdit: document.getElementById("ptkIsEdit").value,
    nipLama: document.getElementById("ptkNipLama").value,
    nip: document.getElementById("inputNip").value,
    nama: document.getElementById("inputNama").value,
    jabatan: document.getElementById("inputJabatan").value,
    lokasi: document.getElementById("inputLokasi").value,
    role: document.getElementById("inputRole").value,
    status: document.getElementById("inputStatus").value,
    password: document.getElementById("inputPassword").value
  };

  // --- 4. KIRIM KE SERVER DENGAN TOKEN ---
  google.script.run.withSuccessHandler(res => {
    // Kembalikan tombol ke semula
    btn.innerHTML = originalText;
    btn.disabled = false;

    // Tampilkan notifikasi (Merah jika error, Biru jika sukses)
    showToast(res.message, !res.success);

    // Jika berhasil, tutup modal & refresh tabel
    if (res.success) {
      closePTKModal();
      loadDataPTK(); 
    }
  })
  .withFailureHandler(err => {
      // Handle jika koneksi putus
      btn.innerHTML = originalText;
      btn.disabled = false;
      showToast("Error Koneksi: " + err.message, true);
  })
  .savePTK(token, payload); // <--- PENTING: Token dikirim sebagai parameter pertama
}


    // ==========================================================
    // BAGIAN C: ADMIN - REKAP ABSENSI (UPDATE: DATE FILTER + LOKASI TUGAS)
    // ==========================================================

function loadDataRekap() {
      const tbody = document.getElementById("tableRekapBody");
      // UPDATE Colspan 12 (karena tambah kolom Lokasi Tugas)
      tbody.innerHTML = '<tr><td colspan="12" class="p-8 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> Memuat data...</td></tr>';
      
      // 1. Reset Input Pencarian & Tanggal
      document.getElementById("rekapSearchInput").value = "";
      document.getElementById("rekapStartDate").value = "";
      document.getElementById("rekapEndDate").value = "";
      
      // 2. [BARU] Reset Dropdown Filter Guru ke "Semua"
      const filterSelect = document.getElementById("filterRekapPTK");
      if(filterSelect) {
          filterSelect.value = "all";
      }
      
      currentRekapPage = 1;

      // 3. Ambil Data Absensi dari Server
      google.script.run.withSuccessHandler(logs => {
         allRekapData = logs || [];
         filteredRekapData = logs || [];
         renderRekapTable();
      }).getRekapBulanan();

      // 4. [BARU] Isi Opsi Dropdown Nama Guru
      // Memanggil fungsi helper untuk mengambil daftar nama dari server
      populateRekapDropdown();
    }

    // --- FUNGSI HELPER BARU (WAJIB ADA) ---
    // Letakkan fungsi ini tepat di bawah loadDataRekap()
    function populateRekapDropdown() {
      const select = document.getElementById("filterRekapPTK");
      if (!select) return;
      
      // Cek apakah dropdown sudah terisi? Jika opsi > 2 (artinya sudah ada nama), tidak perlu load lagi biar hemat
      if (select.options.length > 2) return; 

      google.script.run.withSuccessHandler(ptkList => {
          // Reset opsi awal
          let html = '<option value="all">-- Semua Pegawai --</option>';
          
          // Loop data nama guru
          ptkList.forEach(p => {
              html += `<option value="${p.nip}">${p.nama}</option>`;
          });
          
          select.innerHTML = html;
      }).getPTKNames(); // Menggunakan fungsi server getPTKNames
    }

    function renderRekapTable() {
        const tbody = document.getElementById("tableRekapBody");
        tbody.innerHTML = "";

        if (filteredRekapData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" class="p-8 text-center text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">Data tidak ditemukan.</td></tr>';
            updateRekapPaginationInfo(0, 0, 0);
            return;
        }

        const totalItems = filteredRekapData.length;
        let start = (currentRekapPage - 1) * rekapRowsPerPage;
        let end = start + rekapRowsPerPage;
        if (rekapRowsPerPage === 'all') { start = 0; end = totalItems; }

        const paginatedData = filteredRekapData.slice(start, end);
        const btnFoto = (url) => (url && url.length > 5) ? `<a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-xs"><i class="fas fa-image"></i> Lihat</a>` : `<span class="text-gray-300">-</span>`;
        
        const badgeStatus = (text, type) => {
             if (!text) return `<span class="text-gray-300">-</span>`;
             let color = "bg-gray-100 text-gray-600";
             if (text.includes("Terlambat")) color = "bg-orange-100 text-orange-700";
             else if (text.includes("Cepat")) color = "bg-red-100 text-red-700";
             else if (type === 'Masuk') color = "bg-green-100 text-green-700";
             else if (type === 'Pulang') color = "bg-blue-100 text-blue-700";
             if (['Sakit', 'Izin', 'Cuti', 'Dinas Luar'].some(k => text.includes(k))) color = "bg-purple-100 text-purple-700";
             return `<span class="px-2 py-1 rounded-full text-[10px] font-bold ${color} border border-opacity-20 whitespace-nowrap">${text}</span>`;
        };

        paginatedData.forEach(row => {
           tbody.innerHTML += `
            <tr class="hover:bg-blue-50/30 transition border-b border-gray-100 text-sm">
              <td class="p-3 font-mono text-gray-500 whitespace-nowrap text-xs">${row.tanggal}</td>
              <td class="p-3 font-mono text-gray-500 text-xs">${row.nip}</td>
              <td class="p-3 font-bold text-gray-700 whitespace-nowrap">${row.nama}</td>
              
              <td class="p-3 font-mono text-center bg-green-50/30 text-xs">${row.jamMasuk || '-'}</td>
              <td class="p-3 bg-green-50/30">${badgeStatus(row.statusMasuk, 'Masuk')}</td>
              <td class="p-3 text-center bg-green-50/30">${btnFoto(row.fotoMasuk)}</td>
              <td class="p-3 text-xs text-gray-500 truncate max-w-[120px] bg-green-50/30" title="${row.lokasiMasuk}">
                ${row.lokasiMasuk ? `<i class="fas fa-map-marker-alt text-green-400 mr-1"></i>` + row.lokasiMasuk : '-'}
              </td>

              <td class="p-3 font-mono text-center bg-blue-50/30 text-xs">${row.jamPulang || '-'}</td>
              <td class="p-3 bg-blue-50/30">${badgeStatus(row.statusPulang, 'Pulang')}</td>
              <td class="p-3 text-center bg-blue-50/30">${btnFoto(row.fotoPulang)}</td>
              <td class="p-3 text-xs text-gray-500 truncate max-w-[120px] bg-blue-50/30" title="${row.lokasiPulang}">
                ${row.lokasiPulang ? `<i class="fas fa-map-marker-alt text-blue-400 mr-1"></i>` + row.lokasiPulang : '-'}
              </td>

              <td class="p-3 text-xs text-gray-700 font-medium whitespace-nowrap">
                 ${row.lokasiTugas || '-'}
              </td>
            </tr>`;
        });
        updateRekapPaginationInfo(start + 1, Math.min(end, totalItems), totalItems);
    }

    function updateRekapPaginationInfo(start, end, total) {
        document.getElementById("rekapPageInfo").innerHTML = `Menampilkan <span class="font-bold text-gray-900">${total === 0 ? 0 : start}</span> sampai <span class="font-bold text-gray-900">${end}</span> dari <span class="font-bold text-gray-900">${total}</span> data`;
        const btnPrev = document.getElementById("btnPrevRekap");
        const btnNext = document.getElementById("btnNextRekap");
        btnPrev.disabled = (currentRekapPage === 1);
        if (rekapRowsPerPage === 'all') { btnNext.disabled = true; } 
        else { btnNext.disabled = (currentRekapPage >= Math.ceil(total / rekapRowsPerPage)); }
    }

function handleRekapSearch() {
        // 1. Ambil Nilai dari Input Filter
        const query = document.getElementById("rekapSearchInput").value.toLowerCase();
        const startDate = document.getElementById("rekapStartDate").value;
        const endDate = document.getElementById("rekapEndDate").value;
        
        // [BARU] Ambil Nilai Dropdown Guru
        const filterSelect = document.getElementById("filterRekapPTK");
        // Jika elemen ada ambil valuenya, jika tidak default 'all'
        const selectedNip = filterSelect ? filterSelect.value : 'all';

        // 2. Lakukan Filtering pada Data Global (allRekapData)
        filteredRekapData = allRekapData.filter(row => {
            
            // --- A. LOGIKA FILTER DROPDOWN (PENTING) ---
            // Jika pilihan BUKAN 'all' (artinya memilih guru tertentu)
            // DAN NIP pada data baris ini TIDAK SAMA dengan NIP yang dipilih
            // Maka: Sembunyikan baris ini (return false)
            if (selectedNip !== 'all' && String(row.nip) !== String(selectedNip)) {
                return false;
            }

            // --- B. LOGIKA PENCARIAN TEKS ---
            // Mencari di Nama, NIP, atau Status Masuk
            const matchText = (
                row.nama.toLowerCase().includes(query) || 
                String(row.nip).includes(query) ||
                (row.statusMasuk && row.statusMasuk.toLowerCase().includes(query))
            );

            // --- C. LOGIKA FILTER TANGGAL ---
            let matchDate = true;
            // Format tanggal di data biasanya "yyyy-MM-dd" (string ISO), bisa dibandingkan langsung string-nya
            if (startDate && row.tanggal < startDate) matchDate = false;
            if (endDate && row.tanggal > endDate) matchDate = false;

            // --- HASIL AKHIR ---
            // Baris ditampilkan jika lolos Text Search DAN Date Range
            return matchText && matchDate;
        });

        // 3. Reset ke Halaman 1 & Render Ulang Tabel
        currentRekapPage = 1;
        renderRekapTable();
    }

    function changeRekapRows() {
        const val = document.getElementById("rekapRowsPerPage").value;
        rekapRowsPerPage = (val === 'all') ? 'all' : parseInt(val);
        currentRekapPage = 1;
        renderRekapTable();
    }
    function prevRekapPage() { if (currentRekapPage > 1) { currentRekapPage--; renderRekapTable(); } }
    function nextRekapPage() { const maxPage = Math.ceil(filteredRekapData.length / rekapRowsPerPage); if (rekapRowsPerPage !== 'all' && currentRekapPage < maxPage) { currentRekapPage++; renderRekapTable(); } }


    // ==========================================================
    // BAGIAN D: ADMIN - APPROVAL IZIN
    // ==========================================================

    function loadApprovalList() {
      const tbody = document.getElementById("tableApprovalBody");
      tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> Memuat pengajuan...</td></tr>';
      if(document.getElementById("approvalSearchInput")) document.getElementById("approvalSearchInput").value = "";
      currentApprovalPage = 1;

      google.script.run.withSuccessHandler(list => {
        allApprovalData = list || [];
        filteredApprovalData = list || [];
        renderApprovalTable();
      }).getPendingIzinList();
    }

    function renderApprovalTable() {
        const tbody = document.getElementById("tableApprovalBody");
        tbody.innerHTML = "";

        if (filteredApprovalData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">Tidak ada pengajuan izin yang menunggu.</td></tr>';
            updateApprovalPaginationInfo(0, 0, 0);
            return;
        }

        const totalItems = filteredApprovalData.length;
        let start = (currentApprovalPage - 1) * approvalRowsPerPage;
        let end = start + approvalRowsPerPage;
        if (approvalRowsPerPage === 'all') { start = 0; end = totalItems; }

        const paginatedData = filteredApprovalData.slice(start, end);
        paginatedData.forEach(item => {
          const rentang = `${formatDateShort(item.tglMulai)} s.d ${formatDateShort(item.tglSelesai)}`;
          let btnBukti = (item.bukti && item.bukti.includes("http")) ? `<a href="${item.bukti}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-xs bg-blue-50 px-2 py-1 rounded"><i class="fas fa-paperclip"></i> Lihat File</a>` : `<span class="text-gray-300">-</span>`;

          tbody.innerHTML += `
            <tr class="hover:bg-purple-50/30 transition border-b border-gray-100">
              <td class="p-4 text-gray-500 text-xs font-mono">${formatDateShort(item.timestamp)}</td>
              <td class="p-4 font-bold text-gray-700">${item.nama}<br><span class="text-xs font-normal text-gray-400 font-mono">${item.nip}</span></td>
              <td class="p-4"><span class="px-2 py-0.5 rounded text-xs font-bold bg-purple-100 text-purple-700">${item.jenis}</span><p class="text-xs text-gray-600 mt-1 italic line-clamp-2" title="${item.ket}">"${item.ket}"</p></td>
              <td class="p-4 text-xs font-mono text-gray-600">${rentang}</td>
              <td class="p-4 text-center">${btnBukti}</td>
              <td class="p-4 text-center">
                <div class="flex items-center justify-center gap-2">
                  <button onclick="handleApproval('${item.id}', 'approve')" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1 shadow-sm"><i class="fas fa-check"></i> Setuju</button>
                  <button onclick="handleApproval('${item.id}', 'reject')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1 shadow-sm"><i class="fas fa-times"></i> Tolak</button>
                </div>
              </td>
            </tr>`;
        });
        updateApprovalPaginationInfo(start + 1, Math.min(end, totalItems), totalItems);
    }

    function updateApprovalPaginationInfo(start, end, total) {
        document.getElementById("approvalPageInfo").innerHTML = `Menampilkan <span class="font-bold text-gray-900">${total === 0 ? 0 : start}</span> sampai <span class="font-bold text-gray-900">${end}</span> dari <span class="font-bold text-gray-900">${total}</span> data`;
        const btnPrev = document.getElementById("btnPrevApproval");
        const btnNext = document.getElementById("btnNextApproval");
        btnPrev.disabled = (currentApprovalPage === 1);
        if (approvalRowsPerPage === 'all') { btnNext.disabled = true; } 
        else { btnNext.disabled = (currentApprovalPage >= Math.ceil(total / approvalRowsPerPage)); }
    }

    function handleApprovalSearch() {
        const query = document.getElementById("approvalSearchInput").value.toLowerCase();
        filteredApprovalData = allApprovalData.filter(item => item.nama.toLowerCase().includes(query) || String(item.nip).includes(query) || item.jenis.toLowerCase().includes(query) || item.ket.toLowerCase().includes(query));
        currentApprovalPage = 1;
        renderApprovalTable();
    }
    function changeApprovalRows() {
        const val = document.getElementById("approvalRowsPerPage").value;
        approvalRowsPerPage = (val === 'all') ? 'all' : parseInt(val);
        currentApprovalPage = 1;
        renderApprovalTable();
    }
    function prevApprovalPage() { if (currentApprovalPage > 1) { currentApprovalPage--; renderApprovalTable(); } }
    function nextApprovalPage() { const maxPage = Math.ceil(filteredApprovalData.length / approvalRowsPerPage); if (approvalRowsPerPage !== 'all' && currentApprovalPage < maxPage) { currentApprovalPage++; renderApprovalTable(); } }

function handleApproval(id, action) {
  // --- 1. AMBIL TOKEN SECURITY ---
  const token = localStorage.getItem("authToken");
  if (!token) {
      Swal.fire('Sesi Berakhir', 'Silakan login ulang.', 'error').then(() => logout());
      return;
  }

  // --- 2. TENTUKAN KONFIGURASI ALERT ---
  // Kita bedakan warna dan pesan antara "Setujui" dan "Tolak"
  let titleText, messageText, confirmColor, confirmText;

  if (action === 'approve') {
      titleText = 'Setujui Izin?';
      messageText = "Yakin ingin MENYETUJUI izin ini? Data absensi akan otomatis dibuat.";
      confirmColor = '#10b981'; // Hijau (Tailwind green-500)
      confirmText = 'Ya, Setujui!';
  } else {
      titleText = 'Tolak Izin?';
      messageText = "Yakin ingin MENOLAK izin ini?";
      confirmColor = '#ef4444'; // Merah (Tailwind red-500)
      confirmText = 'Ya, Tolak!';
  }

  // --- 3. TAMPILKAN SWEET ALERT KONFIRMASI ---
  Swal.fire({
      title: titleText,
      text: messageText,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: confirmColor,
      cancelButtonColor: '#6b7280', // Abu-abu
      confirmButtonText: confirmText,
      cancelButtonText: 'Batal',
      reverseButtons: true
  }).then((result) => {
      
      // Jika user klik tombol "Ya"
      if (result.isConfirmed) {
          
          // --- 4. TAMPILKAN LOADING STATE ---
          Swal.fire({
              title: 'Memproses...',
              text: 'Mohon tunggu sebentar.',
              allowOutsideClick: false,
              didOpen: () => {
                  Swal.showLoading();
              }
          });

          // --- 5. KIRIM KE SERVER (DENGAN TOKEN) ---
          google.script.run
              .withSuccessHandler(res => {
                  if (res.success) {
                      // Sukses: Tampilkan pesan & Reload Data
                      Swal.fire('Berhasil!', res.message, 'success');
                      loadApprovalList(); 
                  } else {
                      // Gagal Logika: Tampilkan pesan error
                      Swal.fire('Gagal!', res.message, 'error');
                  }
              })
              .withFailureHandler(err => {
                  // Gagal Koneksi
                  Swal.fire('Error', 'Terjadi kesalahan koneksi: ' + err.message, 'error');
              })
              .processIzinApproval(token, id, action); // <--- PENTING: Kirim token
      }
  });
}


    // ==========================================================
    // BAGIAN E: JADWAL PIKET (NEW FEATURE)
    // ==========================================================

    function loadJadwalPiket() {
      // Toggle tombol tambah & hapus based on role
      if (currentUser && currentUser.role === "ADMIN") {
         document.getElementById("adminPiketControls").classList.remove("hidden");
         document.querySelectorAll(".admin-col").forEach(el => el.classList.remove("hidden"));
      } else {
         document.getElementById("adminPiketControls").classList.add("hidden");
         document.querySelectorAll(".admin-col").forEach(el => el.classList.add("hidden"));
      }

      const tbody = document.getElementById("tablePiketBody");
      tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Memuat data...</td></tr>';

      google.script.run.withSuccessHandler(data => {
        allPiketData = data || [];
        filterPiket('Semua'); // Render awal dengan semua hari
      }).getJadwalPiket();
    }

    function filterPiket(hari) {
      // Update UI tombol filter (active state)
      document.querySelectorAll('.filter-btn-hari').forEach(btn => {
        if(btn.innerText === hari) {
           btn.className = "filter-btn-hari bg-blue-600 text-white px-3 py-1 rounded-full text-xs transition shadow";
        } else {
           btn.className = "filter-btn-hari bg-gray-100 text-gray-600 hover:bg-gray-200 px-3 py-1 rounded-full text-xs transition";
        }
      });

      // Filter Data logic
      let displayData = allPiketData;
      if (hari !== 'Semua') {
        displayData = allPiketData.filter(d => d.hari === hari);
      }
      
      // Sort berdasarkan urutan hari (Senin -> Sabtu)
      const dayOrder = {"Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7};
      displayData.sort((a,b) => (dayOrder[a.hari] || 9) - (dayOrder[b.hari] || 9));

      renderPiketTable(displayData);
    }

// 1. UPDATE: Tambahkan Tombol Edit di Tabel
// --- GANTI FUNGSI renderPiketTable DENGAN INI ---

function renderPiketTable(data) {
  const tbody = document.getElementById("tablePiketBody");
  tbody.innerHTML = "";
  
  // 1. RESET STATUS SELEKSI
  // Setiap kali render ulang (misal ganti filter hari), uncheck header & sembunyikan tombol hapus
  if(document.getElementById("checkAllPiket")) {
      document.getElementById("checkAllPiket").checked = false;
  }
  const btnBulk = document.getElementById("btnBulkDeletePiket");
  if(btnBulk) btnBulk.classList.add("hidden");

  // 2. CEK DATA KOSONG
  if (data.length === 0) {
    // Note: colspan jadi 6 karena ada tambahan kolom checkbox
    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400 bg-gray-50 border border-dashed rounded-lg">Tidak ada jadwal piket.</td></tr>';
    return;
  }

  // 3. CEK ROLE ADMIN
  const isAdmin = (currentUser && currentUser.role === "ADMIN");
  
  // Update visibility kolom header admin (Checkbox Header & Kolom Aksi)
  if(isAdmin) {
      document.querySelectorAll(".admin-col").forEach(el => el.classList.remove("hidden"));
  } else {
      document.querySelectorAll(".admin-col").forEach(el => el.classList.add("hidden"));
  }

  // 4. LOOP DATA
  data.forEach(row => {
    // Persiapkan data JSON aman untuk dikirim ke fungsi Edit
    const rowData = JSON.stringify(row).replace(/"/g, '&quot;');

    let actionButtons = '';
    let checkboxCell = ''; 

    if (isAdmin) {
        // A. Buat Kolom Checkbox (Admin Only)
        // onchange="checkPiketSelection()" dipanggil saat dicentang untuk update tombol hapus
        checkboxCell = `
            <td class="p-4 text-center">
                <input type="checkbox" class="piket-checkbox rounded text-pink-600 focus:ring-pink-500 cursor-pointer w-4 h-4" 
                       value="${row.id}" onchange="checkPiketSelection()">
            </td>
        `;

        // B. Buat Tombol Aksi (Edit & Hapus Satuan)
        actionButtons = `
          <div class="flex items-center justify-center gap-2">
             <button onclick="openModalPiket('edit', ${rowData})" class="text-yellow-600 hover:text-yellow-700 bg-yellow-50 hover:bg-yellow-100 p-2 rounded-lg transition" title="Edit Jadwal">
                <i class="fas fa-edit"></i>
             </button>
             <button onclick="hapusPiket('${row.id}')" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition" title="Hapus Jadwal">
                 <i class="fas fa-trash-alt"></i>
             </button>
          </div>
        `;
    } else {
        // Jika User Biasa: Kolom checkbox disembunyikan via class admin-col
        checkboxCell = `<td class="p-4 hidden admin-col"></td>`; 
    }

    // C. Tentukan Warna Badge Hari
    const colorMap = {"Senin":"blue", "Selasa":"yellow", "Rabu":"green", "Kamis":"purple", "Jumat":"pink", "Sabtu":"orange", "Minggu":"red"};
    const color = colorMap[row.hari] || "gray";

    // 5. RENDER BARIS TABEL
    tbody.innerHTML += `
      <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
         ${checkboxCell}
         <td class="p-4"><span class="px-3 py-1 rounded-full text-xs font-bold bg-${color}-100 text-${color}-700 border border-${color}-200">${row.hari}</span></td>
         <td class="p-4 font-bold text-gray-700">${row.nama}</td>
         <td class="p-4 text-gray-600 text-sm">${row.tugas}</td>
         <td class="p-4 text-gray-500 text-xs font-mono"><i class="fas fa-map-pin mr-1 text-gray-400"></i> ${row.lokasi || '-'}</td>
         <td class="p-4 text-center ${isAdmin ? '' : 'hidden'} admin-col">${actionButtons}</td>
      </tr>
    `;
  });
}


function renderDynamicDays() {
        const container = document.getElementById("containerHariDynamic");
        
        // Safety check: Pastikan container ada
        if (!container) return;

        container.innerHTML = ""; // Bersihkan pesan "Memuat form hari..."

        listHari.forEach(hari => {
            const html = `
            <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 transition hover:bg-white day-item-container shadow-sm">
                
                <label class="flex items-center space-x-3 cursor-pointer mb-2 select-none">
                    <input type="checkbox" name="piketHariCheck" value="${hari}" 
                           onchange="toggleDayInput(this)" 
                           class="form-checkbox text-pink-600 rounded w-5 h-5 focus:ring-pink-500 transition cursor-pointer">
                    <span class="font-bold text-gray-700">${hari}</span>
                </label>
                
                <div class="hidden space-y-3 pl-8 mt-2 border-l-2 border-pink-100" id="inputBox-${hari}">
                    <input type="hidden" class="input-id-hari"> <div>
                      <label class="text-xs font-bold text-gray-500 uppercase">Tugas</label>
                      <input type="text" class="input-tugas w-full p-2 text-sm rounded border border-gray-300 focus:border-pink-500 focus:ring-1 focus:ring-pink-500 outline-none transition" 
                             placeholder="Contoh: Jaga Gerbang">
                    </div>

                    <div>
                      <label class="text-xs font-bold text-gray-500 uppercase">Lokasi</label>
                      <input type="text" class="input-lokasi w-full p-2 text-sm rounded border border-gray-300 focus:border-pink-500 focus:ring-1 focus:ring-pink-500 outline-none transition" 
                             placeholder="Contoh: Pos Utama">
                    </div>
                </div>
            </div>`;
            
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- 3. HELPER: TOGGLE INPUT (Munculkan kolom saat dicentang) ---
function toggleDayInput(checkbox) {
        const hari = checkbox.value;
        const inputBox = document.getElementById(`inputBox-${hari}`);
        
        if (!inputBox) return;

        const inputs = inputBox.querySelectorAll('input[type="text"]');

        if (checkbox.checked) {
            // Jika dicentang: Munculkan input & set Wajib Diisi
            inputBox.classList.remove("hidden");
            inputBox.classList.add("animate-fade-in"); // Efek halus jika ada CSS fade-in
            inputs.forEach(i => i.required = true); 
        } else {
            // Jika uncheck: Sembunyikan & Reset
            inputBox.classList.add("hidden");
            inputBox.classList.remove("animate-fade-in");
            inputs.forEach(i => {
                i.required = false;
                i.value = ""; // Bersihkan teks agar tidak tersimpan sampah
            });
            // Reset ID juga jika perlu
            const idField = inputBox.querySelector('.input-id-hari');
            if(idField) idField.value = "";
        }
    }

    // --- 4. MODIFIKASI: OPEN MODAL ---
// --- FUNGSI BUKA MODAL JADWAL (VERSI FIX DYNAMIC FORM) ---
    function openModalPiket(mode = 'add', data = null) {
       // 1. Render Struktur Hari (Agar form selalu fresh/bersih saat dibuka)
       if (typeof renderDynamicDays === "function") {
           renderDynamicDays();
       } else {
           console.error("Fungsi renderDynamicDays belum ada!");
       }

       const modal = document.getElementById("modalPiket");
       const title = document.getElementById("modalPiketTitle");
       const select = document.getElementById("piketNip");
       const form = modal.querySelector("form");
       
       modal.classList.remove("hidden");
       
       // 2. Reset Form Dasar
       form.reset();
       select.innerHTML = '<option value="">Memuat nama...</option>';
       
       // 3. Load Data PTK ke Dropdown
       google.script.run.withSuccessHandler(ptkList => {
          select.innerHTML = '<option value="">-- Pilih PTK --</option>';
          ptkList.forEach(p => {
             const option = document.createElement("option");
             option.value = p.nip;
             option.text = p.nama;
             
             // Jika mode edit, set selected pada nama yang sesuai
             if (mode === 'edit' && data && String(p.nip) === String(data.nip)) {
                 option.selected = true;
             }
             select.appendChild(option);
          });
       }).getPTKNames();

       // 4. Setup Tampilan Berdasarkan Mode
       if (mode === 'edit' && data) {
           title.innerHTML = `<i class="fas fa-edit text-yellow-500 mr-2"></i> Edit Jadwal`;
           
           // Pastikan elemen hidden nama ada sebelum diisi
           const hiddenNama = document.getElementById("piketNamaHidden");
           if(hiddenNama) hiddenNama.value = data.nama;
           
           // --- LOGIKA PENGISIAN DATA EDIT ---
           const targetHari = data.hari;
           
           // Cari checkbox yang sesuai hari (misal "Senin")
           const checkbox = document.querySelector(`input[name="piketHariCheck"][value="${targetHari}"]`);

           if (checkbox) {
               // 1. Centang Checkbox
               checkbox.checked = true;
               
               // 2. Munculkan Input (Panggil fungsi toggle manual)
               if (typeof toggleDayInput === "function") toggleDayInput(checkbox);

               // 3. Isi Data ke Input Spesifik Hari Tersebut
               const container = document.getElementById(`inputBox-${targetHari}`);
               if (container) {
                   // Isi ID (PENTING: Agar server tahu ini update, bukan insert baru)
                   container.querySelector('.input-id-hari').value = data.id; 
                   
                   // Isi Tugas & Lokasi Lama
                   container.querySelector('.input-tugas').value = data.tugas;
                   container.querySelector('.input-lokasi').value = data.lokasi;
               }
           }

       } else {
           // Mode Tambah Baru
           title.innerHTML = `<i class="fas fa-calendar-plus text-pink-600 mr-2"></i> Tambah Jadwal`;
           
           // HAPUS REFERENSI KE "piketId" DISINI KARENA SUDAH TIDAK ADA DI HTML UTAMA
           // Cukup reset nama hidden jika ada
           const hiddenNama = document.getElementById("piketNamaHidden");
           if(hiddenNama) hiddenNama.value = "";
       }
    }

    // --- FUNGSI BANTU: SET NAMA PTK OTOMATIS (Wajib Ada) ---
    function setPiketNama() {
        const select = document.getElementById("piketNip");
        const hidden = document.getElementById("piketNamaHidden");
        
        if (select && hidden) {
            if (select.selectedIndex > 0) {
                hidden.value = select.options[select.selectedIndex].text;
            } else {
                hidden.value = "";
            }
        }
    }



    // 3. UPDATE: Handle Submit (Kirim ID)
function handlePiketSubmit(e) {
       e.preventDefault();
       const btn = document.getElementById("btnSavePiket");
       const originalText = btn.innerText;

       // 1. IDENTIFIKASI HARI YANG DIPILIH
       // Kita cari semua checkbox dengan name="piketHariCheck" yang dicentang
       const checkboxes = document.querySelectorAll('input[name="piketHariCheck"]:checked');
       
       // 2. VALIDASI DASAR
       if (checkboxes.length === 0) {
           Swal.fire({
               icon: 'warning',
               title: 'Peringatan',
               text: 'Harap pilih minimal satu hari bertugas.'
           });
           return;
       }

       // 3. KUMPULKAN DATA DETIL PER HARI
       // Kita akan menyusun Array of Objects (Banyak data sekaligus)
       const jadwalList = [];
       const nip = document.getElementById("piketNip").value;
       const nama = document.getElementById("piketNamaHidden").value;

       // Loop setiap checkbox hari yang aktif
       checkboxes.forEach(cb => {
           const hari = cb.value; // Contoh: "Senin"
           
           // Cari container input khusus untuk hari tersebut (sesuai ID yang digenerate renderDynamicDays)
           const container = document.getElementById(`inputBox-${hari}`);
           
           if (container) {
               // Ambil value dari input-input di dalam container tersebut
               const idJadwal = container.querySelector('.input-id-hari').value; // ID (kosong jika baru, ada jika edit)
               const tugasVal = container.querySelector('.input-tugas').value;
               const lokasiVal = container.querySelector('.input-lokasi').value;

               // Masukkan ke dalam list
               jadwalList.push({
                   id: idJadwal, 
                   hari: hari,
                   tugas: tugasVal,
                   lokasi: lokasiVal,
                   nip: nip,
                   nama: nama
               });
           }
       });

       // 4. UI LOADING
       btn.innerText = "Menyimpan...";
       btn.disabled = true;

       // 5. KIRIM KE SERVER (Menggunakan fungsi saveBulkJadwal)
       google.script.run.withSuccessHandler(res => {
          btn.innerText = originalText;
          btn.disabled = false;
          showToast(res.message, !res.success);
          
          if (res.success) {
             // Tutup Modal
             document.getElementById("modalPiket").classList.add("hidden");
             // Refresh Tabel Jadwal
             loadJadwalPiket();
          }
       }).saveBulkJadwal(jadwalList); // <--- PENTING: Panggil fungsi saveBulkJadwal di Code.gs
    }


    function hapusPiket(id) {
      if(!confirm("Hapus jadwal piket ini?")) return;
      const token = localStorage.getItem("authToken");

      google.script.run.withSuccessHandler(res => {
          showToast(res.message, !res.success);
          loadJadwalPiket();
      }).deleteJadwalPiket(token, id); // <--- TAMBAHKAN TOKEN
    }


    // ==========================================================
    // BAGIAN F: DASHBOARD PTK (HISTORY & IZIN)
    // ==========================================================

    function loadPTKData() {
      // 1. Reset Tampilan Awal (Loading State)
      document.getElementById("statusMasukTime").innerText = "--:--";
      document.getElementById("statusPulangTime").innerText = "--:--";
      
      // Reset Badge Status ke default (abu-abu/loading)
      const elMasuk = document.getElementById("statusMasukKet");
      if(elMasuk) {
          elMasuk.innerText = "Belum Absen";
          elMasuk.className = "text-sm text-green-600 font-medium mb-1.5 bg-green-100 px-2 py-0.5 rounded"; 
      }
      
      const elPulang = document.getElementById("statusPulangKet");
      if(elPulang) {
          elPulang.innerText = "Belum Absen";
          elPulang.className = "text-sm text-blue-600 font-medium mb-1.5 bg-blue-100 px-2 py-0.5 rounded";
      }

      document.getElementById("ptkHistoryTable").innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin mr-2"></i> Memuat data...</td></tr>';
      
      // Reset Input Pencarian & Halaman
      if(document.getElementById("historySearchInput")) document.getElementById("historySearchInput").value = "";
      currentHistoryPage = 1;

      // Sembunyikan Alert Piket (Reset)
      const alertCard = document.getElementById("piketAlertCard");
      if (alertCard) alertCard.classList.add("hidden");

      // --- AMBIL TOKEN SECURITY ---
      const token = localStorage.getItem("authToken");

      // 2. Panggil Data dari Server (Kirim Token, BUKAN NIP)
      google.script.run.withSuccessHandler(data => {
        
        // --- UPDATE PENTING: SIMPAN STATUS KE VARIABEL GLOBAL ---
        // Variabel ini dipakai di openAbsenModal() untuk auto-select tombol
        if (data.statusMasuk) userTodayStatus.masuk = true;
        else userTodayStatus.masuk = false;

        if (data.statusPulang) userTodayStatus.pulang = true;
        else userTodayStatus.pulang = false;
        // ---------------------------------------------------------

        // A. Render Status Absen Masuk
        if(data.statusMasuk) {
          document.getElementById("statusMasukTime").innerText = data.statusMasuk.waktu;
          const el = document.getElementById("statusMasukKet");
          el.innerText = data.statusMasuk.status;
          
          // Logika Warna Badge (Merah jika Terlambat, Hijau jika Tepat)
          if (data.statusMasuk.status.includes("Terlambat")) {
            el.className = "text-sm text-red-600 font-medium mb-1.5 bg-red-100 px-2 py-0.5 rounded";
          } else {
            el.className = "text-sm text-green-600 font-medium mb-1.5 bg-green-100 px-2 py-0.5 rounded";
          }
        }

        // B. Render Status Absen Pulang
        if(data.statusPulang) {
          document.getElementById("statusPulangTime").innerText = data.statusPulang.waktu;
          const el = document.getElementById("statusPulangKet");
          el.innerText = data.statusPulang.status;
          
          // Logika Warna Badge (Merah jika Pulang Cepat, Biru jika Normal)
          if (data.statusPulang.status.includes("Cepat")) {
            el.className = "text-sm text-red-600 font-medium mb-1.5 bg-red-100 px-2 py-0.5 rounded";
          } else {
            el.className = "text-sm text-blue-600 font-medium mb-1.5 bg-blue-100 px-2 py-0.5 rounded";
          }
        }

        // C. Tampilkan Alert Piket (Jika Ada Data)
        if (data.myPiket && alertCard) {
          // Hapus class 'hidden' agar card muncul
          alertCard.classList.remove("hidden");
          
          // Isi Teks Tugas & Lokasi
          document.getElementById("piketTugasDisplay").innerText = data.myPiket.tugas;
          document.getElementById("piketLokasiDisplay").innerText = data.myPiket.lokasi || "Area Sekolah";
        }

        // D. Render Tabel Riwayat Absensi
        allHistoryData = (data.history && data.history.length > 0) ? data.history : [];
        filteredHistoryData = allHistoryData;
        renderHistoryTable();

      }).getPTKDashboardData(token); // <--- UPDATE DI SINI: Mengirim token
    }

    function renderHistoryTable() {
        const tbody = document.getElementById("ptkHistoryTable");
        tbody.innerHTML = "";

        if (filteredHistoryData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-gray-400">Belum ada riwayat absensi.</td></tr>`;
            updateHistoryPaginationInfo(0, 0, 0);
            return;
        }

        const totalItems = filteredHistoryData.length;
        let start = (currentHistoryPage - 1) * historyRowsPerPage;
        let end = start + historyRowsPerPage;
        if (historyRowsPerPage === 'all') { start = 0; end = totalItems; }

        const paginatedData = filteredHistoryData.slice(start, end);
        const renderFotoBtn = (url) => (url && url.length > 5) ? `<a href="${url}" target="_blank" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded-full transition"><i class="fas fa-image"></i></a>` : `<span class="text-gray-300">-</span>`;
        const renderBadge = (text, type) => {
            if(!text) return `<span class="text-gray-300">-</span>`;
            let color = "bg-gray-100 text-gray-600";
            if(type === 'masuk') { color = text.includes('Terlambat') ? "bg-red-100 text-red-600" : "bg-green-100 text-green-600"; }
            else { color = text.includes('Cepat') ? "bg-red-100 text-red-600" : "bg-blue-100 text-blue-600"; }
            if(['Sakit', 'Izin', 'Cuti'].some(k => text.includes(k))) color = "bg-purple-100 text-purple-600";
            return `<span class="px-2 py-1 rounded text-[10px] font-bold ${color}">${text}</span>`;
        };

        paginatedData.forEach(row => {
            tbody.innerHTML += `
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition text-sm">
                    <td class="p-4 font-medium text-gray-700 whitespace-nowrap">${row.tanggal}</td>
                    <td class="p-4 text-center font-mono font-bold text-gray-600">${row.jamMasuk || '-'}</td>
                    <td class="p-4 whitespace-nowrap">${renderBadge(row.statusMasuk, 'masuk')}</td>
                    <td class="p-4 text-center">${renderFotoBtn(row.fotoMasuk)}</td>
                    <td class="p-4 text-center font-mono font-bold text-gray-600">${row.jamPulang || '-'}</td>
                    <td class="p-4 whitespace-nowrap">${renderBadge(row.statusPulang, 'pulang')}</td>
                    <td class="p-4 text-center">${renderFotoBtn(row.fotoPulang)}</td>
                </tr>`;
        });
        updateHistoryPaginationInfo(start + 1, Math.min(end, totalItems), totalItems);
    }

    function updateHistoryPaginationInfo(start, end, total) {
        document.getElementById("historyPageInfo").innerHTML = `Menampilkan <span class="font-bold text-gray-900">${total === 0 ? 0 : start}</span> - <span class="font-bold text-gray-900">${end}</span> dari <span class="font-bold text-gray-900">${total}</span>`;
        const btnPrev = document.getElementById("btnPrevHistory");
        const btnNext = document.getElementById("btnNextHistory");
        btnPrev.disabled = (currentHistoryPage === 1);
        if (historyRowsPerPage === 'all') { btnNext.disabled = true; } 
        else { btnNext.disabled = (currentHistoryPage >= Math.ceil(total / historyRowsPerPage)); }
    }

    function handleHistorySearch() {
        const query = document.getElementById("historySearchInput").value.toLowerCase();
        filteredHistoryData = allHistoryData.filter(row => row.tanggal.toLowerCase().includes(query) || (row.statusMasuk && row.statusMasuk.toLowerCase().includes(query)) || (row.statusPulang && row.statusPulang.toLowerCase().includes(query)));
        currentHistoryPage = 1;
        renderHistoryTable();
    }
    function changeHistoryRows() {
        const val = document.getElementById("historyRowsPerPage").value;
        historyRowsPerPage = (val === 'all') ? 'all' : parseInt(val);
        currentHistoryPage = 1;
        renderHistoryTable();
    }
    function prevHistoryPage() { if (currentHistoryPage > 1) { currentHistoryPage--; renderHistoryTable(); } }
    function nextHistoryPage() { const maxPage = Math.ceil(filteredHistoryData.length / historyRowsPerPage); if (historyRowsPerPage !== 'all' && currentHistoryPage < maxPage) { currentHistoryPage++; renderHistoryTable(); } }


    // ==========================================================
    // BAGIAN G: FORM IZIN
    // ==========================================================

    function handleIzinSubmit(e) {
        e.preventDefault();
        const btn = document.getElementById("btnKirimIzin");
        const originalText = btn.innerHTML;
        const fileInput = document.getElementById("izinFile");

        // 1. Ambil Token Keamanan
        const token = localStorage.getItem("authToken");
        
        // Jika token hilang (user clear cache/sesi habis), paksa logout
        if (!token) {
            Swal.fire({
                icon: 'error',
                title: 'Sesi Berakhir',
                text: 'Silakan login ulang untuk melanjutkan.'
            }).then(() => {
                logout();
            });
            return;
        }

        // 2. Ubah UI ke status Loading
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MENGIRIM...';
        btn.disabled = true;

        // 3. Siapkan Payload (Tanpa NIP & Nama)
        // Server akan mengisi NIP & Nama berdasarkan Token
        const payload = {
            jenis: document.getElementById("izinJenis").value,
            tglMulai: document.getElementById("izinMulai").value,
            tglSelesai: document.getElementById("izinSelesai").value,
            keterangan: document.getElementById("izinKet").value,
            fileData: null,
            fileName: null
        };

        // Fungsi internal untuk mengirim data ke Google Apps Script
        const sendData = () => {
            google.script.run
                .withSuccessHandler(res => {
                    // Kembalikan tombol ke kondisi semula
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    // Tampilkan notifikasi
                    showToast(res.message, !res.success);
                    
                    // Jika sukses, reset form dan reload tabel history
                    if(res.success) {
                        e.target.reset(); 
                        loadIzinHistory();
                    }
                })
                .withFailureHandler(err => {
                    // Handle jika server error / koneksi putus
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showToast("Gagal mengirim data: " + err.message, true);
                })
                // --- UPDATE PENTING DI SINI ---
                .submitIzinRequest(token, payload);
        };

        // 4. Cek Lampiran File
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            
            // Validasi Ukuran (Maks 2MB)
            if(file.size > 2 * 1024 * 1024) { 
                alert("Ukuran file terlalu besar (Maksimal 2MB)");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            // Baca file jadi Base64
            const reader = new FileReader();
            reader.onload = function(e) {
                payload.fileData = e.target.result;
                payload.fileName = file.name;
                sendData(); // Kirim setelah file terbaca
            };
            reader.readAsDataURL(file);
        } else {
            // Jika tidak ada file, langsung kirim
            sendData();
        }
    }

    function loadIzinHistory() {
      const tbody = document.getElementById("tableIzinHistory");
      tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center"><i class="fas fa-spinner fa-spin"></i> Memuat...</td></tr>';
      google.script.run.withSuccessHandler(data => {
        tbody.innerHTML = "";
        if(data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Belum ada riwayat.</td></tr>';
          return;
        }
        data.forEach(row => {
          let statusColor = "bg-gray-100 text-gray-600";
          if(row.status === "Disetujui") statusColor = "bg-green-100 text-green-600";
          if(row.status === "Ditolak") statusColor = "bg-red-100 text-red-600";
          if(row.status === "Menunggu") statusColor = "bg-purple-100 text-purple-600";
          tbody.innerHTML += `<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="p-3 text-xs text-gray-500">${row.tanggal}</td><td class="p-3"><div class="font-bold text-sm text-gray-700">${row.jenis}</div><div class="text-xs text-gray-400 truncate max-w-[150px]">${row.ket}</div></td><td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-bold ${statusColor}">${row.status}</span></td></tr>`;
        });
      }).getMyIzinHistory(currentUser.nip);
    }

function loadPTKRekapPage() {
       // Setup Tanggal Default (1 Bulan Terakhir) jika kosong
       const today = new Date();
       const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
       const toInputDate = (d) => d.toISOString().split('T')[0];
       
       if(!document.getElementById("ptkRekapStart").value) {
           document.getElementById("ptkRekapStart").value = toInputDate(firstDay);
           document.getElementById("ptkRekapEnd").value = toInputDate(today);
       }

       // Reset Search & Page
       if(document.getElementById("ptkRekapSearch")) document.getElementById("ptkRekapSearch").value = "";
       currentPTKRekapPage = 1;
       
       const tbody = document.getElementById("tablePTKRekapBody");
       tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Memuat data kehadiran...</td></tr>';
       
       google.script.run.withSuccessHandler(data => {
          allPTKReportData = data || [];
          handlePTKRekapFilter(); // Jalankan filter awal
       }).getPTKReportData(currentUser.nip);
    }
    
function handlePTKRekapFilter() {
    // 1. Ambil Nilai Input dari DOM
    const startDate = document.getElementById("ptkRekapStart").value;
    const endDate = document.getElementById("ptkRekapEnd").value;
    
    // Cek elemen search (gunakan empty string jika element belum ter-load)
    const searchInput = document.getElementById("ptkRekapSearch");
    const query = searchInput ? searchInput.value.toLowerCase() : "";

    // 2. Filter Data (Hasil disimpan ke variabel global filteredPTKRekapData)
    // Variabel 'filteredPTKRekapData' ini nanti akan dipakai oleh fungsi pagination
    filteredPTKRekapData = allPTKReportData.filter(row => {
        // A. Logika Filter Tanggal
        if (startDate && row.tanggal < startDate) return false;
        if (endDate && row.tanggal > endDate) return false;

        // B. Logika Filter Pencarian (Search)
        if (query) {
            // Gabungkan data kolom menjadi satu string agar mudah dicari
            // Kita cari di Status Masuk, Status Pulang, Lokasi, Jam
            const combinedText = `${row.statusMasuk || ''} ${row.statusPulang || ''} ${row.lokasiTugas || ''} ${row.jamMasuk || ''} ${row.jamPulang || ''}`.toLowerCase();
            
            // Jika query tidak ditemukan dalam teks gabungan, exclude data ini
            if (!combinedText.includes(query)) return false;
        }

        return true; // Data lolos filter
    });

    // 3. Hitung Statistik (Berdasarkan data yang sudah difilter)
    let countHadir = 0;
    let countTelat = 0;
    let countCepat = 0;
    let countIzin = 0;

    filteredPTKRekapData.forEach(r => {
        countHadir++; // Menghitung total baris data yang tampil
        
        // Cek Terlambat
        if(r.statusMasuk && r.statusMasuk.includes("Terlambat")) countTelat++;
        
        // Cek Pulang Cepat
        if(r.statusPulang && r.statusPulang.includes("Cepat")) countCepat++;
        
        // Cek Izin/Sakit/Cuti/Dinas
        const izinKeywords = ['Sakit', 'Izin', 'Cuti', 'Dinas'];
        if(r.statusMasuk && izinKeywords.some(x => r.statusMasuk.includes(x))) countIzin++;
    });

    // 4. Update Angka Statistik di HTML
    // Menggunakan pengecekan if() agar tidak error jika elemen belum ada
    if(document.getElementById("ptkStatHadir")) document.getElementById("ptkStatHadir").innerText = countHadir;
    if(document.getElementById("ptkStatTelat")) document.getElementById("ptkStatTelat").innerText = countTelat;
    if(document.getElementById("ptkStatCepat")) document.getElementById("ptkStatCepat").innerText = countCepat;
    if(document.getElementById("ptkStatIzin")) document.getElementById("ptkStatIzin").innerText = countIzin;

    // 5. Reset ke Halaman 1 & Panggil Render Tabel
    // Karena data berubah (difilter), kita harus kembali ke halaman pertama
    currentPTKRekapPage = 1; 
    
    // Fungsi ini (renderPTKRekapTable) yang bertugas memotong data (slice) sesuai limit baris per halaman
    renderPTKRekapTable(); 
}

function handlePTKRekapSearch() {
        handlePTKRekapFilter(); // Panggil fungsi master filter
    }

    // 2. LOGIKA RENDER TABEL & PAGINATION
    function renderPTKRekapTable() {
        const tbody = document.getElementById("tablePTKRekapBody");
        tbody.innerHTML = "";
        
        const totalItems = filteredPTKRekapData.length;

        if (totalItems === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500 bg-gray-50 border border-dashed rounded-lg">Tidak ada data ditemukan.</td></tr>';
            updatePTKPaginationInfo(0, 0, 0);
            return;
        }
        
        // Hitung start & end index
        let start = (currentPTKRekapPage - 1) * ptkRekapRowsPerPage;
        let end = start + ptkRekapRowsPerPage;
        
        if (ptkRekapRowsPerPage === 'all') { 
            start = 0; 
            end = totalItems; 
        }

        // Slice data sesuai halaman
        const paginatedData = filteredPTKRekapData.slice(start, end);
        
        // Helper untuk Badge Status
        const badge = (txt) => {
            if(!txt) return "-";
            let color = "bg-gray-100 text-gray-600";
            if(txt.includes("Terlambat") || txt.includes("Cepat")) color = "bg-red-100 text-red-600";
            else if(['Sakit','Izin','Cuti','Dinas'].some(x => txt.includes(x))) color = "bg-purple-100 text-purple-600";
            else if(txt === "Tepat Waktu") color = "bg-green-100 text-green-600";
            return `<span class="px-2 py-1 rounded text-xs font-bold ${color}">${txt}</span>`;
        };
        
        // Loop Render Baris
        paginatedData.forEach(row => {
            tbody.innerHTML += `
              <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                 <td class="p-4 font-mono text-gray-600 text-xs">${row.tanggal}</td>
                 <td class="p-4 font-bold text-gray-700">${row.jamMasuk || '-'}</td>
                 <td class="p-4">${badge(row.statusMasuk)}</td>
                 <td class="p-4 font-bold text-gray-700">${row.jamPulang || '-'}</td>
                 <td class="p-4">${badge(row.statusPulang)}</td>
                 <td class="p-4 text-xs text-gray-500">${row.lokasiTugas || '-'}</td>
              </tr>
            `;
        });

        // Update Info Pagination
        updatePTKPaginationInfo(start + 1, Math.min(end, totalItems), totalItems);
    }

    // 3. HELPER PAGINATION & STATISTIK
    function updatePTKPaginationInfo(start, end, total) {
        document.getElementById("ptkRekapPageInfo").innerHTML = 
            `Menampilkan <span class="font-bold text-gray-900">${total === 0 ? 0 : start}</span> - <span class="font-bold text-gray-900">${end}</span> dari <span class="font-bold text-gray-900">${total}</span>`;
            
        const btnPrev = document.getElementById("btnPrevPTKRekap");
        const btnNext = document.getElementById("btnNextPTKRekap");
        
        btnPrev.disabled = (currentPTKRekapPage === 1);
        
        if (ptkRekapRowsPerPage === 'all') {
            btnNext.disabled = true;
        } else {
            btnNext.disabled = (currentPTKRekapPage >= Math.ceil(total / ptkRekapRowsPerPage));
        }
    }

    function calculatePTKStats(data) {
        let countHadir = 0;
        let countTelat = 0;
        let countCepat = 0;
        let countIzin = 0;
        
        data.forEach(r => {
            countHadir++;
            if(r.statusMasuk && r.statusMasuk.includes("Terlambat")) countTelat++;
            if(r.statusPulang && r.statusPulang.includes("Cepat")) countCepat++;
            if(r.statusMasuk && ['Sakit','Izin','Cuti','Dinas'].some(x => r.statusMasuk.includes(x))) countIzin++;
        });
        
        document.getElementById("ptkStatHadir").innerText = countHadir;
        document.getElementById("ptkStatTelat").innerText = countTelat;
        document.getElementById("ptkStatCepat").innerText = countCepat;
        document.getElementById("ptkStatIzin").innerText = countIzin;
    }

    // Event Listeners untuk Pagination Controls
    function changePTKRekapRows() {
        const val = document.getElementById("ptkRekapRows").value;
        ptkRekapRowsPerPage = (val === 'all') ? 'all' : parseInt(val);
        currentPTKRekapPage = 1;
        renderPTKRekapTable();
    }
    
    function prevPTKRekapPage() { 
        if (currentPTKRekapPage > 1) { 
            currentPTKRekapPage--; 
            renderPTKRekapTable(); 
        } 
    }
    
    function nextPTKRekapPage() { 
        const maxPage = Math.ceil(filteredPTKRekapData.length / ptkRekapRowsPerPage);
        if (ptkRekapRowsPerPage !== 'all' && currentPTKRekapPage < maxPage) { 
            currentPTKRekapPage++; 
            renderPTKRekapTable(); 
        } 
    }

// --- FUNGSI DOWNLOAD EXCEL (ADMIN) ---
function downloadExcelRekap() {
        // 1. Cek apakah ada data yang sedang tampil
        if (!filteredRekapData || filteredRekapData.length === 0) {
            Swal.fire('Info', 'Tidak ada data untuk didownload.', 'info');
            return;
        }

        const btn = document.getElementById("btnDownloadExcel");
        const originalContent = btn.innerHTML;

        // 2. Ubah Tombol jadi Loading
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
        btn.disabled = true;

        // 3. Tentukan Nama File Dinamis (Kolektif vs Individu)
        const dateStr = new Date().toISOString().slice(0, 10); // Format YYYY-MM-DD
        const filterSelect = document.getElementById("filterRekapPTK");
        const selectedNip = filterSelect ? filterSelect.value : 'all';
        
        let filename = "Rekap_Absensi_Kolektif_" + dateStr; // Default

        // Jika filter bukan 'all', gunakan Nama Guru di judul file
        if (selectedNip !== 'all') {
            const selectedOption = filterSelect.options[filterSelect.selectedIndex];
            // Ambil teks nama, ganti spasi dengan underscore agar aman untuk nama file
            const namaGuru = selectedOption.text.replace(/[^a-zA-Z0-9]/g, "_"); 
            filename = "Rekap_" + namaGuru + "_" + dateStr;
        }

        // 4. Kirim Data ke Backend (Server)
        google.script.run
            .withSuccessHandler(res => {
                // A. Kembalikan Tombol ke Semula
                btn.innerHTML = originalContent;
                btn.disabled = false;

                // B. Trigger Download Otomatis
                // Google Script mengembalikan string base64 Excel
                const link = document.createElement('a');
                link.href = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + res.base64;
                link.download = res.filename; // Gunakan nama file dari server (opsional) atau variabel filename lokal
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // C. Notifikasi Sukses
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                });
                Toast.fire({ icon: 'success', title: 'File Excel berhasil diunduh' });
            })
            .withFailureHandler(err => {
                // D. Handle Error
                btn.innerHTML = originalContent;
                btn.disabled = false;
                Swal.fire('Error', 'Gagal membuat Excel: ' + err.message, 'error');
            })
            .generateExcelReport(filename, filteredRekapData); // Kirim Nama File & Data yang sudah difilter
    }
    // ==========================================================
    // BAGIAN H: KAMERA & GEOLOCATION (FIXED & UPDATED)
    // ==========================================================

    function openAbsenModal() {
      const modal = document.getElementById("modalAbsen");
      
      // 1. Tampilkan Modal dengan Animasi
      modal.classList.remove("hidden");
      setTimeout(() => modal.classList.remove("opacity-0"), 10);
      
      // 2. LOGIKA OTOMATIS: Pilih Jenis Absen (Masuk/Pulang)
      // Kita ambil elemen radio button-nya
      const radioMasuk = document.querySelector('input[value="Absen Masuk"]');
      const radioPulang = document.querySelector('input[value="Absen Pulang"]');

      // Cek status hari ini (variabel global 'userTodayStatus' diisi oleh loadPTKData)
      if (userTodayStatus.masuk && !userTodayStatus.pulang) {
          // Kasus: SUDAH Masuk, tapi BELUM Pulang
          // Maka otomatis pilih menu PULANG
          if(radioPulang) radioPulang.checked = true;
      } else {
          // Kasus: Belum Masuk ATAU Sudah Selesai Semua
          // Maka default kembali ke MASUK
          if(radioMasuk) radioMasuk.checked = true;
      }

      // 3. Nyalakan Fitur Kamera & GPS
      startCamera();
      getLocation();
    }

    function closeAbsenModal() {
      const modal = document.getElementById("modalAbsen");
      modal.classList.add("opacity-0");
      setTimeout(() => {
          modal.classList.add("hidden");
          const video = document.getElementById("cameraFeed");
          if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
          }
      }, 300);
    }

    function startCamera() {
      const status = document.getElementById("locationStatus");
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(stream => { 
            document.getElementById("cameraFeed").srcObject = stream; 
        })
        .catch(err => {
            alert("Gagal mengakses kamera: " + err.message);
            status.innerHTML = `<span class="text-red-500"><i class="fas fa-video-slash"></i> Kamera Error</span>`;
        });
    }

    function getLocation() {
      const status = document.getElementById("locationStatus");
      const btn = document.getElementById("btnCapture");
      status.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Mencari koordinat GPS...`;
      status.className = "flex items-center justify-center gap-2 text-xs py-2 px-3 bg-gray-50 rounded-lg border border-gray-200 text-gray-500";
      
      if (!navigator.geolocation) {
        status.innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> Browser tidak support GPS</span>`;
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLocation.lat = pos.coords.latitude;
          userLocation.lng = pos.coords.longitude;
          
          status.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-map-marker-alt"></i> Lokasi Terkunci</span>`;
          status.classList.replace("bg-gray-50", "bg-green-50");
          status.classList.replace("border-gray-200", "border-green-200");
          status.classList.replace("text-gray-500", "text-green-700");
          btn.disabled = false;
        },
        (err) => {
          let msg = "Gagal GPS";
          if(err.code == 1) msg = "Izin Ditolak";
          else if(err.code == 2) msg = "Sinyal Hilang";
          else if(err.code == 3) msg = "Timeout";
          
          status.innerHTML = `<span class="text-red-500 font-bold"><i class="fas fa-map-marker-slash"></i> ${msg}</span>`;
          status.classList.replace("bg-gray-50", "bg-red-50");
          status.classList.replace("border-gray-200", "border-red-200");
          btn.disabled = true;
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

function captureAndSubmit() {
    const video = document.getElementById("cameraFeed");
    const canvas = document.getElementById("cameraCanvas");
    const btn = document.getElementById("btnCapture");
    const originalBtnText = btn.innerHTML;

    // 1. AMBIL TOKEN DARI STORAGE (WAJIB)
    // Ini perbaikan utamanya. Kita ambil token sesi user.
    const token = localStorage.getItem("authToken");

    // Jika token tidak ada (user clear cache/hack), paksa logout
    if (!token) {
        Swal.fire({
            icon: 'error',
            title: 'Sesi Tidak Valid',
            text: 'Silakan login ulang aplikasi.'
        }).then(() => {
            logout();
        });
        return;
    }

    // 2. PROSES INPUT & GAMBAR
    // Cek input radio button (safe check)
    const jenisEl = document.querySelector('input[name="jenisAbsen"]:checked');
    const jenis = jenisEl ? jenisEl.value : "Absen Masuk";

    // Setup Canvas ukuran Video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    
    // Efek Cermin (Mirror)
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0);
    
    // Kompresi gambar ke Base64 (0.6 kualitas sedang)
    const photoBase64 = canvas.toDataURL('image/jpeg', 0.6);

    // 3. SIAPKAN DATA (PAYLOAD)
    // Pastikan koordinat diambil dari variable global (userLocation atau currentLat)
    let latData = 0;
    let lngData = 0;

    // Cek variabel mana yang dipakai di script geolocation Anda
    if (typeof userLocation !== 'undefined' && userLocation.lat) {
        latData = userLocation.lat;
        lngData = userLocation.lng;
    } else if (typeof currentLat !== 'undefined') {
        latData = currentLat;
        lngData = currentLng;
    }

    const payload = {
        jenis: jenis,
        foto: photoBase64,
        lat: latData,
        lng: lngData,
        // Data user lain (NIP/Nama) sebaiknya diambil server dari Token agar tidak bisa dipalsukan client
        // Tapi kita kirim lokasi tugas sebagai info tambahan
        lokasiTugas: (currentUser && currentUser.lokasi) ? currentUser.lokasi : "-"
    };

    // 4. UI LOADING
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> MENGIRIM...';
    btn.disabled = true;

    // 5. KIRIM KE SERVER (DENGAN TOKEN)
    google.script.run
        .withSuccessHandler(res => {
            // Reset Tombol
            btn.innerHTML = originalBtnText;
            btn.disabled = false;

            if (res.success) {
                // Tutup Modal
                closeAbsenModal();
                
                // Notifikasi Sukses
                Swal.fire({
                    icon: 'success',
                    title: 'Absensi Berhasil!',
                    text: res.message,
                    timer: 2000,
                    showConfirmButton: false
                });

                // Refresh Data Dashboard agar status berubah
                loadPTKData(); 
            } else {
                // Error Logika (Jarak jauh, sudah absen, dll)
                Swal.fire('Gagal', res.message, 'error');
            }
        })
        .withFailureHandler(error => {
            // Error Koneksi / Server crash
            btn.innerHTML = originalBtnText;
            btn.disabled = false;
            console.error(error);
            Swal.fire('Error Sistem', 'Gagal menghubungi server: ' + error.message, 'error');
        })
        // --- PERUBAHAN PENTING DISINI ---
        // Pastikan nama fungsi di Server adalah 'handleAbsensi' (atau sesuaikan dengan di Code.gs)
        // Dan parameter ke-2 ADALAH TOKEN
        .handleAbsensi(payload, token); 
}



// Helper Update Input
function updateKoordinatInput(lat, lng) {
    document.getElementById("set_Lat_Sekolah").value = lat.toFixed(6);
    document.getElementById("set_Lng_Sekolah").value = lng.toFixed(6);
}

function checkAutoLogin(tokenFromStorage) {
    // Safety check: Jika token kosong, hentikan (biasanya sudah dicek di DOMContentLoaded)
    if (!tokenFromStorage) return;

    google.script.run
        .withSuccessHandler(res => {
            if (res.success) {
                // --- KONDISI 1: SUKSES LOGIN ---
                
                // 1. Simpan data user ke variabel global
                currentUser = res.data;

                // 2. Setup UI (Nama, Foto, Menu Admin/PTK sesuai role)
                setupUI(currentUser);

                // 3. --- UPDATE PENTING: PRELOAD DATA ---
                // Panggil fungsi ini agar semua data dimuat di awal.
                // Saat user pindah halaman nanti, tidak perlu loading lagi.
                preloadAppData(currentUser); 
                // ---------------------------------------

                // 4. Transisi dari Loader ke Dashboard
                // Fungsi ini akan menyembunyikan loader dan memunculkan id="mainLayout"
                hideLoaderAndShow("mainLayout");

            } else {
                // --- KONDISI 2: TOKEN TIDAK VALID / KADALUARSA ---
                console.log("Auto-login gagal: " + res.message);
                
                // Hapus token sampah dari penyimpanan browser
                localStorage.removeItem("authToken"); 

                // Transisi dari Loader ke Halaman Login
                hideLoaderAndShow("loginSection");
            }
        })
        .withFailureHandler(err => {
            // --- KONDISI 3: ERROR KONEKSI / SERVER ---
            console.log("Koneksi gagal saat auto-login: " + err);
            
            // Demi keamanan UX, jika error, arahkan user untuk login ulang manual
            hideLoaderAndShow("loginSection");
        })
        .checkSession(tokenFromStorage); // Panggil fungsi verifikasi di Server (Code.gs)
}

// --- TAMBAHKAN FUNGSI-FUNGSI BARU INI DI BAWAH renderPiketTable ---

// 1. Handle "Pilih Semua" di Header
function toggleSelectAllPiket(headerCheckbox) {
    const checkboxes = document.querySelectorAll('.piket-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = headerCheckbox.checked;
    });
    checkPiketSelection();
}

// 2. Cek status seleksi untuk memunculkan tombol hapus massal
function checkPiketSelection() {
    const checkedBoxes = document.querySelectorAll('.piket-checkbox:checked');
    const btn = document.getElementById("btnBulkDeletePiket");
    const countSpan = document.getElementById("countPiketDelete");
    
    if (checkedBoxes.length > 0) {
        btn.classList.remove("hidden");
        countSpan.innerText = checkedBoxes.length;
    } else {
        btn.classList.add("hidden");
    }
}

// 3. Eksekusi Hapus Banyak
function handleBulkDeletePiket() {
    const checkedBoxes = document.querySelectorAll('.piket-checkbox:checked');
    if (checkedBoxes.length === 0) return;

    Swal.fire({
        title: 'Hapus Massal?',
        text: `Anda yakin ingin menghapus ${checkedBoxes.length} jadwal terpilih?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Hapus!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            
            // Ambil semua ID yang dicentang
            const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
            const token = localStorage.getItem("authToken");

            // UI Loading pada tombol bulk delete
            const btn = document.getElementById("btnBulkDeletePiket");
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';
            btn.disabled = true;

            google.script.run.withSuccessHandler(res => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                showToast(res.message, !res.success);
                
                if (res.success) {
                    // Sembunyikan tombol delete bulk
                    btn.classList.add("hidden");
                    // Uncheck header
                    document.getElementById("checkAllPiket").checked = false;
                    // Reload Tabel
                    loadJadwalPiket();
                }
            }).deleteBulkJadwalPiket(token, idsToDelete);
        }
    });
}

// GANTI FUNCTION initMapAdmin YANG LAMA DENGAN INI
// GANTI FUNCTION initMapAdmin YANG LAMA DENGAN VERSI FINAL INI
function initMapAdmin() {
    // 1. Ambil nilai dari Input
    let latInput = document.getElementById('set_Lat_Sekolah').value;
    let lngInput = document.getElementById('set_Lng_Sekolah').value;
    let radiusInput = document.getElementById('set_Radius_Meter').value;

    // 2. BERSIHKAN FORMAT ANGKA (Hapus titik ribuan jika ada)
    // Mengubah "1.003.639.804" menjadi format angka yang bisa dibaca sistem
    if(latInput && latInput.split('.').length > 2) latInput = latInput.replace(/\./g, ''); 
    if(lngInput && lngInput.split('.').length > 2) lngInput = lngInput.replace(/\./g, '');

    // 3. VALIDASI KOORDINAT
    let lat = parseFloat(latInput);
    let lng = parseFloat(lngInput);
    let radius = parseInt(radiusInput);

    // Default ke MONAS (Jakarta) jika data kosong atau Error (NaN)
    if (isNaN(lat)) lat = -6.175392;
    if (isNaN(lng)) lng = 106.827153;
    if (isNaN(radius)) radius = 100;

    // --- LOGIKA ANTI-NYASAR (FIX SCREENSHOT ANDA) ---
    // Jika Longitude < 90 (di luar Indonesia/masuk laut Afrika), paksa balik ke Bengkulu/Jakarta
    // Angka 1.003 akan terdeteksi disini dan diperbaiki otomatis
    if (lng < 90 || lng > 150) {
        console.warn("Koordinat terdeteksi di luar Indonesia, mereset ke default.");
        lat = -6.1758410; // Koordinat Bengkulu (Default)
        lng = 106.8269779;
        
        // Update input agar user tahu koordinatnya direset
        document.getElementById('set_Lat_Sekolah').value = lat;
        document.getElementById('set_Lng_Sekolah').value = lng;
    }
    // ------------------------------------------------

    // 4. RESET & GAMBAR PETA
    if (adminMap !== null) {
        adminMap.remove();
        adminMap = null;
    }

    try {
        // Render Peta
        adminMap = L.map('mapPicker').setView([lat, lng], 16); // Zoom level 16 agar jalanan terlihat

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap'
        }).addTo(adminMap);

        // Marker & Circle
        adminMarker = L.marker([lat, lng], { draggable: true }).addTo(adminMap);
        adminCircle = L.circle([lat, lng], {
            color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: radius
        }).addTo(adminMap);

        // Event: Geser Marker
        adminMarker.on('dragend', function (e) {
            var position = adminMarker.getLatLng();
            document.getElementById('set_Lat_Sekolah').value = position.lat.toFixed(7);
            document.getElementById('set_Lng_Sekolah').value = position.lng.toFixed(7);
            if (adminCircle) adminCircle.setLatLng(position);
        });

        // Event: Ubah Radius
        const radiusEl = document.getElementById('set_Radius_Meter');
        const newRadiusEl = radiusEl.cloneNode(true);
        radiusEl.parentNode.replaceChild(newRadiusEl, radiusEl);
        newRadiusEl.addEventListener('input', function() {
            let val = parseInt(this.value) || 0;
            if (adminCircle) adminCircle.setRadius(val);
        });

        // 5. PAKSA REFRESH UKURAN (Agar tidak blank/abu-abu)
        setTimeout(() => { 
            adminMap.invalidateSize(); 
            adminMap.panTo([lat, lng]); 
        }, 500);

    } catch (e) {
        console.error("Map Error: ", e);
    }
}

// --- FUNGSI 2: Ambil Lokasi GPS Saat Ini (Fitur Baru) ---
function getCurrentLocationAdmin() {
    if (!navigator.geolocation) {
        Swal.fire("Error", "Browser tidak mendukung Geolocation.", "error");
        return;
    }

    Swal.fire({
        title: 'Mencari Lokasi...',
        text: 'Sedang mengambil koordinat GPS...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Update Input
            document.getElementById('set_Lat_Sekolah').value = lat;
            document.getElementById('set_Lng_Sekolah').value = lng;

            // Update Map, Marker, dan Circle
            if (adminMap && adminMarker) {
                const newLatLng = new L.LatLng(lat, lng);
                
                adminMarker.setLatLng(newLatLng); // Pindah Marker
                if (adminCircle) adminCircle.setLatLng(newLatLng); // Pindah Lingkaran
                
                adminMap.setView(newLatLng, 19); // Zoom in
            } else {
                initMapAdmin();
            }

            Swal.fire({
                icon: 'success',
                title: 'Lokasi Ditemukan!',
                timer: 1000,
                showConfirmButton: false
            });
        },
        (error) => {
            Swal.fire("Gagal", "Tidak dapat mengambil lokasi. Pastikan GPS aktif.", "error");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

// --- LOGIKA RENDER TABEL JADWAL (WAJIB ADA) ---

// 1. Definisikan List Hari
const daysList = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"];

// 2. Fungsi Menggambar Baris Tabel
function renderJadwalSettings(settings) {
    const tbody = document.getElementById("tbodyJadwalSettings");
    if (!tbody) return; // Safety check
    
    tbody.innerHTML = ""; // Bersihkan "Memuat jadwal..."

    daysList.forEach(hari => {
        // Ambil data existing atau default
        let data = { masuk_awal: "06:00", masuk_akhir: "07:30", pulang_awal: "14:00", pulang_akhir: "16:00", libur: false };
        
        // Coba ambil dari settings backend
        if (settings[`Jadwal_${hari}`]) {
            try { data = JSON.parse(settings[`Jadwal_${hari}`]); } catch(e){}
        }

        const isLibur = data.libur ? "checked" : "";
        const disableInput = data.libur ? "disabled bg-slate-100 text-slate-400" : "bg-white";

        const row = `
        <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
            <td class="p-3 font-bold text-slate-700">${hari}</td>
            <td class="p-3 text-center">
                <input type="checkbox" id="libur_${hari}" onchange="toggleRowLibur('${hari}')" class="w-5 h-5 text-red-600 rounded focus:ring-red-500 border-gray-300 cursor-pointer" ${isLibur}>
            </td>
            <td class="p-3">
                <div class="flex items-center gap-2">
                    <input type="time" id="ma_${hari}" value="${data.masuk_awal}" class="w-24 p-1.5 rounded border border-slate-300 text-xs ${disableInput}">
                    <span class="text-slate-400">-</span>
                    <input type="time" id="mk_${hari}" value="${data.masuk_akhir}" class="w-24 p-1.5 rounded border border-slate-300 text-xs ${disableInput}">
                </div>
            </td>
            <td class="p-3">
                <div class="flex items-center gap-2">
                    <input type="time" id="pa_${hari}" value="${data.pulang_awal}" class="w-24 p-1.5 rounded border border-slate-300 text-xs ${disableInput}">
                    <span class="text-slate-400">-</span>
                    <input type="time" id="pk_${hari}" value="${data.pulang_akhir}" class="w-24 p-1.5 rounded border border-slate-300 text-xs ${disableInput}">
                </div>
            </td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

// 3. Fungsi Helper Toggle (Mematikan input saat dicentang Libur)
function toggleRowLibur(hari) {
    const isChecked = document.getElementById(`libur_${hari}`).checked;
    const inputs = [`ma_${hari}`, `mk_${hari}`, `pa_${hari}`, `pk_${hari}`];
    
    inputs.forEach(id => {
        const el = document.getElementById(id);
        if(isChecked) {
            el.disabled = true;
            el.classList.add("bg-slate-100", "text-slate-400");
            el.classList.remove("bg-white");
        } else {
            el.disabled = false;
            el.classList.remove("bg-slate-100", "text-slate-400");
            el.classList.add("bg-white");
        }
    });
}

// 1. Load Daftar Libur saat settings dibuka
function loadHolidays() {
   const tbody = document.getElementById("tbodyLiburNasional");
   const emptyMsg = document.getElementById("emptyLiburMsg");
   tbody.innerHTML = '<tr><td colspan="3" class="p-2 text-center">Memuat...</td></tr>';

   google.script.run.withSuccessHandler(data => {
      tbody.innerHTML = "";
      if (data.length === 0) {
         emptyMsg.classList.remove("hidden");
      } else {
         emptyMsg.classList.add("hidden");
         data.forEach(item => {
            // Format tanggal agar cantik (opsional)
            const row = `
            <tr class="hover:bg-red-50">
               <td class="p-2 font-mono text-slate-600">${item.tanggal}</td>
               <td class="p-2 font-medium text-slate-800">${item.keterangan}</td>
               <td class="p-2 text-right">
                  <button type="button" onclick="hapusLibur('${item.tanggal}')" class="text-red-500 hover:text-red-700">
                     <i class="fas fa-trash-alt"></i>
                  </button>
               </td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
         });
      }
   }).getHolidayList();
}

// 2. Tambah Libur
function tambahLibur() {
   const dateVal = document.getElementById("inputLiburDate").value;
   const descVal = document.getElementById("inputLiburDesc").value;
   const token = localStorage.getItem("authToken");

   if (!dateVal || !descVal) {
      showToast("Harap isi tanggal dan keterangan!", true);
      return;
   }

   // UI Loading kecil
   const btn = document.querySelector("button[onclick='tambahLibur()']");
   const oriHtml = btn.innerHTML;
   btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
   btn.disabled = true;

   google.script.run.withSuccessHandler(res => {
      btn.innerHTML = oriHtml;
      btn.disabled = false;
      showToast(res.message, !res.success);
      if(res.success) {
         document.getElementById("inputLiburDate").value = "";
         document.getElementById("inputLiburDesc").value = "";
         loadHolidays(); // Refresh tabel
      }
   }).addHoliday(dateVal, descVal, token);
}

// 3. Hapus Libur
function hapusLibur(dateStr) {
   if(!confirm("Hapus libur tanggal " + dateStr + "?")) return;
   const token = localStorage.getItem("authToken");

   google.script.run.withSuccessHandler(res => {
      showToast(res.message, !res.success);
      if(res.success) loadHolidays();
   }).deleteHoliday(dateStr, token);
}
</script>
</body>
</html>